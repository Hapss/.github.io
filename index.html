<!-- Chosen Palette: Dark Neutrals (Black, Grey, White) with Honkai Red/Purple accents for UI elements. -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Houkai Gakuen 2 –ê—Ä—Ö–∏–≤ –°—é–∂–µ—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #5c5c5c; /* –§–æ–Ω —Å–∞–π—Ç–∞ */
            color: #e5e7eb;
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        /* VN Overlay for fixed size box */
        .vn-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }
        .speaker-name {
            background-color: #2a2a2a;
            color: #ca7cfe;
            padding: 4px 12px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: inline-block;
            font-weight: bold;
            font-size: 1.25rem; /* text-xl */
        }

        /* Sprite Positioning (applied to the container) */
        .sprite-position {
            position: absolute;
            bottom: 0;
            max-height: 95%; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã —Å–ø—Ä–∞–π—Ç–∞ */
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10;
            display: flex; 
            justify-content: center;
            align-items: flex-end;
            width: 50%; /* –ó–∞–Ω–∏–º–∞–µ—Ç –ø–æ–ª–æ–≤–∏–Ω—É —à–∏—Ä–∏–Ω—ã VN-—ç–∫—Ä–∞–Ω–∞ */
            height: 100%;
        }
        .sprite-position.left {
            left: 0;
        }
        .sprite-position.right {
            right: 0;
        }
        
        /* Sprite Image */
        .sprite-image {
            max-height: 100%; /* –ü–æ–ª–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            width: auto;
            object-fit: contain;
        }

        /* Dimming Class */
        .dimmed-sprite {
            opacity: 0.4;
        }

        /* Custom styles for Dialogue Log entries */
        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .log-entry:hover {
            background-color: #333;
        }
        .current-log-entry {
            background-color: #4a4a4a !important; /* –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ä–µ–ø–ª–∏–∫–∏ */
            border-left: 3px solid #ca7cfe;
            padding-left: 12px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Firebase Setup (MANDATORY) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥–æ–π
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anon';

        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                async function authenticate() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser?.uid || 'anon-user';
                        console.log(`[Firebase] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`);
                    } catch (error) {
                        console.error("[Firebase] –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                    }
                }
                authenticate();
            } catch (e) {
                console.error("[Firebase] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            }
        }
    </script>
    
    <!-- Audio Element (Hidden) -->
    <audio id="chapterAudio" preload="auto" style="display: none;"></audio>

    <!-- 1. Header Bar -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 p-4 shadow-xl text-white" style="background-color: #2a2a2a;">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 id="headerTitle" class="text-xl font-bold tracking-wider">Houkai Gakuen 2 –ê—Ä—Ö–∏–≤ –°—é–∂–µ—Ç–∞</h1>
            
            <div class="flex items-center space-x-4">
                 <!-- Volume Control -->
                <div class="flex items-center space-x-2 bg-gray-700 rounded-lg p-2 transition hover:ring-2 ring-red-400">
                    <span id="volumeIcon" class="text-xl">üîä</span>
                    <input type="range" id="volumeInput" min="0" max="100" value="50" class="h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer range-sm">
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –∏ –ø–æ–º–æ—â—å -->
                <button id="resetButton" onclick="resetProgress()" class="px-3 py-1 bg-red-800 hover:bg-red-700 rounded-full transition duration-150 text-sm">–°–±—Ä–æ—Å</button>
                <button id="helpButton" onclick="showHelpModal()" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-full transition duration-150 text-sm">?</button>
                <select id="languageSelect" onchange="initializeOrUpdateUI()" class="bg-gray-700 text-white rounded-lg p-2 cursor-pointer transition hover:ring-2 ring-red-400">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                    <option value="cn">‰∏≠Êñá</option>
                </select>
            </div>
        </div>
    </header>

    <!-- 2. Main Content Area -->
    <main class="pt-20 pb-4 px-4 max-w-7xl mx-auto min-h-screen">
        
        <!-- Controls Panel -->
        <div class="bg-gray-700 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[180px]">
                <label for="storyTypeSelect" id="labelStoryType" class="block text-sm font-medium mb-1 text-gray-300">–¢–∏–ø —Å—é–∂–µ—Ç–∞</label>
                <select id="storyTypeSelect" onchange="updateChapterSelect(); saveProgress()" class="w-full bg-gray-800 text-white rounded-lg p-2.5 cursor-pointer focus:ring-red-400 focus:border-red-400 transition">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="flex-1 min-w-[250px]">
                <label for="chapterSelect" id="labelChapter" class="block text-sm font-medium mb-1 text-gray-300">–°—é–∂–µ—Ç</label>
                <select id="chapterSelect" onchange="enableLoadButton(); saveProgress()" class="w-full bg-gray-800 text-white rounded-lg p-2.5 cursor-pointer focus:ring-red-400 focus:border-red-400 transition">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <button id="loadButton" onclick="updateStoryContent(0)" class="min-w-[120px] bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50" disabled>
                <span id="loadText">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
            </button>
        </div>

        <!-- 3. Visual Novel Viewer (Main View) -->
        <!-- VN Viewer starts with a neutral background and hidden dialogue box -->
        <div id="vnViewer" class="relative w-full aspect-[16/9] bg-gray-900 rounded-xl shadow-2xl overflow-hidden flex flex-col justify-end transition-colors duration-500" 
             style="min-height: 400px; background-image: url('https://placehold.co/1920x1080/2a2a2a/fca5a5?text=–í—ã–±–µ—Ä–∏—Ç–µ+—Å—é–∂–µ—Ç+–∏+–Ω–∞–∂–º–∏—Ç–µ+–ó–∞–≥—Ä—É–∑–∏—Ç—å'); background-size: cover; background-position: center;"
             onclick="handleVnClick(event)"> 

            <!-- Log Toggle Button -->
            <button id="logToggleButton" onclick="toggleLog()" 
                class="absolute top-4 right-4 z-30 bg-gray-800 hover:bg-red-700 text-white p-3 rounded-full shadow-lg transition duration-150 hidden">
                <!-- SVG for Book Open icon: https://www.svgrepo.com/show/521518/book-open.svg -->
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.22 4.5 7.5 4.5A2.75 2.75 0 004.75 7.25v9.5A2.75 2.75 0 007.5 19.5c1.72 0 3.332-.977 4.5-2.753m0-13C13.168 5.477 14.78 4.5 16.5 4.5A2.75 2.75 0 0119.25 7.25v9.5A2.75 2.75 0 0116.5 19.5c-1.72 0-3.332-.977-4.5-2.753"></path>
                </svg>
            </button>
            
            <!-- Sprite Container (Now with persistent sprite elements) -->
            <div id="spriteContainer" class="absolute inset-0 z-10 pointer-events-none flex justify-center items-end p-4">
                
                <!-- Left Sprite (Persistent element) -->
                <div id="spriteLeftContainer" class="sprite-position left hidden">
                    <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏: –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
                    <img id="spriteLeft" class="sprite-image" src="" alt="–õ–µ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" 
                         onerror="console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–π—Ç–∞ (–õ–µ–≤—ã–π): –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏:', this.src); this.parentElement.classList.add('hidden');">
                </div>
                
                <!-- Right Sprite (Persistent element) -->
                <div id="spriteRightContainer" class="sprite-position right hidden">
                    <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏: –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
                    <img id="spriteRight" class="sprite-image" src="" alt="–ü—Ä–∞–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" 
                         onerror="console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–π—Ç–∞ (–ü—Ä–∞–≤—ã–π): –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏:', this.src); this.parentElement.classList.add('hidden');">
                </div>

            </div>

            <!-- Dialogue Wrapper: Contains Speaker (above) and fixed-size Text Box (below) -->
            <div id="dialogueWrapper" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 transition-all duration-300 opacity-100 hidden">
                
                <!-- Speaker Name Container (Above the main box) -->
                <div id="speakerNameContainer" class="text-left mb-0 ml-8"> 
                    <div id="currentSpeaker" class="speaker-name rounded-t-lg rounded-b-none"></div>
                </div>
                
                <!-- Dialogue Text Content Box -->
                <div id="dialogueContentBox" 
                    class="vn-overlay w-[900px] h-[200px] p-8 flex items-start justify-start text-left
                            rounded-xl shadow-2xl overflow-hidden"
                    onclick="event.stopPropagation()"> 
                    <!-- –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ –¥–∏–∞–ª–æ–≥–∞ -->
                    <p id="currentText" class="text-xl leading-tight transition-opacity duration-300">–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center hidden" onclick="showHelpModal()">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-lg w-11/12 transform transition-all duration-300 scale-95" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-xl font-bold text-red-400">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</h3>
                <button onclick="showHelpModal()" class="text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <p id="helpContent" class="text-gray-300 leading-relaxed"></p>
        </div>
    </div>

    <!-- Dialogue Log Modal -->
    <div id="logModal" class="fixed inset-0 z-40 hidden" onclick="toggleLog()">
        <div id="logContent" 
            class="absolute top-0 right-0 h-full w-full sm:w-1/3 bg-gray-900 border-l-4 border-red-500 shadow-2xl p-6 transform translate-x-full transition-transform duration-300"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                <h2 class="text-xl font-bold text-red-400">–õ–æ–≥ –î–∏–∞–ª–æ–≥–æ–≤</h2>
                <button onclick="toggleLog()" class="text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="logContainer" class="h-[calc(100%-60px)] overflow-y-auto">
                <!-- Dialogue entries will be added here by JS -->
                <p class="text-gray-500 text-center mt-8">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—é–∂–µ—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ª–æ–≥.</p>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL CONSTANTS ---
        const STORAGE_KEY = 'hg2_story_progress';
        const STORY_BASE_PATH = 'story/'; // –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è JSON: story/ru/main_ch1.json
        const SPRITE_BASE_PATH = 'sprites/'; // –ë–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Å–ø—Ä–∞–π—Ç–æ–≤
        const AUDIO_BASE_PATH = 'audio/'; 
        const DEFAULT_BG_URL = 'https://placehold.co/1920x1080/2a2a2a/fca5a5?text=–í—ã–±–µ—Ä–∏—Ç–µ+—Å—é–∂–µ—Ç+–∏+–Ω–∞–∂–º–∏—Ç–µ+–ó–∞–≥—Ä—É–∑–∏—Ç—å';
        
        let currentDialogue = []; 
        let currentDialogueIndex = 0;
        let dialogueIsLoaded = false;
        
        let spriteLeftContainer, spriteRightContainer;
        let spriteLeftElement, spriteRightElement;
        let chapterAudio; 
        
        // --- STORY METADATA (–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–ª–∞–≤) ---
        // –≠—Ç–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –Ω–∞–ª–∏—á–∏—é —Ñ–∞–π–ª–æ–≤.
        const KNOWN_CHAPTERS = {
            "main_ch1": { ru: "–ì–ª–∞–≤–∞ 1: –í—ã–±—Ä–æ—Å –•–æ—É–∫–∞—è", en: "Chapter 1: The Honkai Eruption", cn: "Á´†ËäÇ 1: Â¥©ÂùèÁàÜÂèë" }, 
            "main_ch2": { ru: "–ì–ª–∞–≤–∞ 2: –ö–∏–∞–Ω–∞ –Ω–∞–Ω–æ—Å–∏—Ç –æ—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä!", en: "Chapter 2: Kiana Strikes Back!", cn: "Á´†ËäÇ 2: Áê™‰∫öÂ®úÂèçÂáª" }, 
            "extra_ex1": { ru: "–≠–∫—Å—Ç—Ä–∞ 1: –õ–µ—Ç–Ω–∏–π –ø–ª—è–∂", en: "Extra 1: Summer Beach", cn: "È¢ùÂ§ñ 1: Â§èÊó•Ê≤ôÊª©" },
            "boss_b1": { ru: "–ë–æ—Å—Å 1: –•–µ—Ä—É–≤–∏–º", en: "Boss 1: Cherubim", cn: "È¶ñÈ¢Ü 1: Êô∫Â§©‰Ωø" },
            "vn_vn1": { ru: "VN 1: –ü—Ä–æ–ª–æ–≥ –ö–∏–∞–Ω—ã", en: "VN 1: Kiana's Prologue", cn: "VN 1: Áê™‰∫öÂ®úÂ∫èÁ´†" },
            "ln_r1": { ru: "–†–æ–º–∞–Ω 1: –ü—Ä–∏–∑–Ω–∞–Ω–∏–µ", en: "Novel 1: Confession", cn: "Â∞èËØ¥ 1: ÂëäÁôΩ" }
        };

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å—é–∂–µ—Ç–æ–≤ –ø–æ —Ç–∏–ø—É
        const STORY_GROUPS = {
            main: { ru: "–û—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç", en: "Main Story", cn: "‰∏ªÁ∫øÂâßÊÉÖ", prefix: "main_" },
            extra: { ru: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—é–∂–µ—Ç", en: "Extra Story", cn: "È¢ùÂ§ñÂâßÊÉÖ", prefix: "extra_" },
            bosses: { ru: "–ë–æ—Å—Å—ã", en: "Boss Fights", cn: "È¶ñÈ¢ÜÊàò", prefix: "boss_" },
            vn: { ru: "–í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞", en: "Visual Novel", cn: "ËßÜËßâÂ∞èËØ¥", prefix: "vn_" },
            romance: { ru: "–†–æ–º–∞–Ω", en: "Romance", cn: "Novel", prefix: "ln_" }
        };

        // –ö—ç—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≥–ª–∞–≤: { chapterKey: { lang: true/false, ... }, ... }
        const chapterAvailabilityCache = {};

        // --- I18N DATA (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        const i18n = {
            ru: {
                headerTitle: "Houkai Gakuen 2 –ê—Ä—Ö–∏–≤ –°—é–∂–µ—Ç–∞",
                labelStoryType: "–¢–∏–ø —Å—é–∂–µ—Ç–∞",
                labelChapter: "–°—é–∂–µ—Ç",
                loadText: "–ó–∞–≥—Ä—É–∑–∏—Ç—å",
                resetProgress: "–°–±—Ä–æ—Å",
                errorFetch: "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é.",
                logTitle: "–õ–æ–≥ –î–∏–∞–ª–æ–≥–æ–≤",
                loadingCheck: "–ü—Ä–æ–≤–µ—Ä–∫–∞...",
                helpTitle: "–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞—Ä—Ö–∏–≤–æ–º:",
                helpText: "–≠—Ç–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∞—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–æ–≤ Honkai Gakuen 2.\n\n1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ—Ä—Ö–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å [–¢–∏–ø —Å—é–∂–µ—Ç–∞] –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é [–ì–ª–∞–≤—É].\n2. –ù–∞–∂–º–∏—Ç–µ [–ó–∞–≥—Ä—É–∑–∏—Ç—å].\n3. **–í –æ–∫–Ω–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–π –Ω–æ–≤–µ–ª–ª—ã –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∏–∫ –≤ –ø—Ä–∞–≤–æ–π —á–∞—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –î–∞–ª–µ–µ –∏ –∫–ª–∏–∫ –≤ –ª–µ–≤–æ–π —á–∞—Å—Ç–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ù–∞–∑–∞–¥.**\n4. –í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è. –°–∞–π—Ç –∑–∞–ø–æ–º–Ω–∏—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥–ª–∞–≤—É –∏ —Ä–µ–ø–ª–∏–∫—É, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –≤—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å.\n5. –ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å [–õ–æ–≥ –¥–∏–∞–ª–æ–≥–æ–≤], –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∫–Ω–∏–≥–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É VN-–æ–∫–Ω–∞. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å **–≥—Ä–æ–º–∫–æ—Å—Ç—å** –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ –ø–æ–ª–∑—É–Ω–æ–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ."
            },
            en: {
                headerTitle: "Houkai Gakuen 2 Story Archive",
                labelStoryType: "Story Type",
                labelChapter: "Story (Chapter)",
                loadText: "Load",
                resetProgress: "Reset",
                errorFetch: "Content loading error: file not found or network issue.",
                logTitle: "Dialogue Log",
                loadingCheck: "Checking...",
                helpTitle: "How to use the Archive:",
                helpText: "This is an interactive story archive for Honkai Gakuen 2.\n\n1. Use the top dropdowns to select the [Story Type] and a specific [Chapter].\n2. Click [Load].\n3. **In the Visual Novel viewer, use click on the right side to go Next and click on the left side to go Back.**\n4. Your progress is saved automatically. The site will remember the selected chapter and the dialogue line you stopped at.\n5. To open the [Dialogue Log], click the book icon in the top right of the VN viewer. You can adjust the **audio volume** using the slider in the header."
            },
            cn: {
                headerTitle: "Â¥©ÂùèÂ≠¶Âõ≠2 ÂâßÊÉÖÊ°£Ê°à",
                labelStoryType: "ÂâßÊÉÖÁ±ªÂûã",
                labelChapter: "ÂâßÊÉÖ (Á´†ËäÇ)",
                loadText: "Âä†ËΩΩ",
                resetProgress: "ÈáçÁΩÆ",
                errorFetch: "ÂÜÖÂÆπÂä†ËΩΩÈîôËØØÔºöÊú™ÊâæÂà∞Êñá‰ª∂ÊàñÁΩëÁªúÈóÆÈ¢ò„ÄÇ",
                logTitle: "ÂØπËØùËÆ∞ÂΩï",
                loadingCheck: "Ê≠£Âú®Ê£ÄÊü•...",
                helpTitle: "Â¶Ç‰Ωï‰ΩøÁî®Ê°£Ê°àÔºö",
                helpText: "ËøôÊòØ‰∏Ä‰∏™Â¥©ÂùèÂ≠¶Âõ≠2ÁöÑ‰∫§‰∫íÂºèÂâßÊÉÖÊ°£Ê°à„ÄÇ\n\n1. ‰ΩøÁî®È°∂ÈÉ®‰∏ãÊãâÂàóË°®ÈÄâÊã©ÂâßÊÉÖÁ±ªÂûãÂíåÁâπÂÆöÁ´†ËäÇ„ÄÇ\n2. ÁÇπÂáªÂä†ËΩΩ„ÄÇ\n3. **Âú®ËßÜËßâÂ∞èËØ¥Êü•ÁúãÂô®‰∏≠Ôºå‰ΩøÁî®Âè≥‰æßÁÇπÂáªËøõË°å‰∏ã‰∏ÄÈ°µÔºåÂ∑¶‰æßÁÇπÂáªËøõË°å‰∏ä‰∏ÄÈ°µ„ÄÇ**\n4. ÊÇ®ÁöÑËøõÂ∫¶Â∞ÜËá™Âä®‰øùÂ≠ò„ÄÇÁΩëÁ´ô‰ºöËÆ∞‰ΩèÈÄâÊã©ÁöÑÁ´†ËäÇÂíåÊÇ®ÂÅúÊ≠¢ÁöÑÂØπËØùË°å„ÄÇ\n5. Ë¶ÅÊâìÂºÄÂØπËØùËÆ∞ÂΩïÔºåËØ∑ÁÇπÂáª VN Êü•ÁúãÂô®Âè≥‰∏äËßíÁöÑ‰π¶Êú¨ÂõæÊ†á„ÄÇÊÇ®ÂèØ‰ª•‰ΩøÁî®Ê†áÈ¢ò‰∏≠ÁöÑÊªëÂùóË∞ÉÊï¥**Èü≥È¢ëÈü≥Èáè**„ÄÇ"
            }
        };

        // --- CORE FETCH/CHECK LOGIC ---
        
        /** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª –≥–ª–∞–≤—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∫—ç—à. */
        async function checkChapterAvailability(fullStoryKey, lang) {
            if (!chapterAvailabilityCache[fullStoryKey]) {
                chapterAvailabilityCache[fullStoryKey] = {};
            }
            
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
            if (chapterAvailabilityCache[fullStoryKey][lang] !== undefined) {
                return chapterAvailabilityCache[fullStoryKey][lang];
            }

            const filePath = `${STORY_BASE_PATH}${lang}/${fullStoryKey}.json`;

            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º GET —Å –Ω–µ–±–æ–ª—å—à–∏–º —Ç–∞–π–º–∞—É—Ç–æ–º, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞
                const response = await fetch(filePath, { method: 'GET' }); 
                
                const available = response.ok;
                chapterAvailabilityCache[fullStoryKey][lang] = available;
                return available;
            } catch (e) {
                // –°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏ —Ç–∞–π–º–∞—É—Ç–∞
                chapterAvailabilityCache[fullStoryKey][lang] = false;
                return false;
            }
        }
        
        // --- AUDIO CONTROL FUNCTIONS (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        
        function setVolume(volume) {
            if (chapterAudio) {
                chapterAudio.volume = volume;
            }
            const volumeIcon = document.getElementById('volumeIcon');
            if (volumeIcon) {
                if (volume > 0.5) volumeIcon.textContent = 'üîä'; 
                else if (volume > 0) volumeIcon.textContent = 'üîâ'; 
                else volumeIcon.textContent = 'üîá'; 
            }
        }
        
        function handleVolumeChange() {
            const volumeInput = document.getElementById('volumeInput');
            const volume = parseFloat(volumeInput.value) / 100; 
            setVolume(volume);
            saveProgress();
        }

        function playChapterAudio(audioFileName) {
            if (chapterAudio && audioFileName) {
                const currentSrc = chapterAudio.getAttribute('src');
                const newSrc = AUDIO_BASE_PATH + audioFileName;

                if (currentSrc !== newSrc) {
                    chapterAudio.pause();
                    chapterAudio.setAttribute('src', newSrc);
                    chapterAudio.load(); 
                    chapterAudio.loop = true;
                }
                
                const playPromise = chapterAudio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(e => {
                        console.warn("Autoplay was prevented. User interaction (click) required to start audio.", e);
                    });
                }
            } else if (chapterAudio) {
                chapterAudio.pause();
            }
        }


        // --- PROGRESS MANAGEMENT ---
        
        function saveProgress() {
            const volumeInput = document.getElementById('volumeInput');
            const progress = {
                lang: document.getElementById('languageSelect').value,
                type: document.getElementById('storyTypeSelect').value,
                chapter: document.getElementById('chapterSelect').value, 
                index: currentDialogueIndex,
                volume: volumeInput ? parseFloat(volumeInput.value) / 100 : 0.5 
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
            console.log('Progress saved:', progress);
        }

        async function loadProgress() {
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            
            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –∏ I18n
            await initializeOrUpdateUI(); // –¢–µ–ø–µ—Ä—å –∂–¥–µ–º, –ø–æ–∫–∞ –ø—Ä–æ–≥—Ä—É–∑—è—Ç—Å—è —Ç–∏–ø—ã

            if (!savedProgress) {
                return;
            }

            const progress = JSON.parse(savedProgress);
            const langSelect = document.getElementById('languageSelect');
            const typeSelect = document.getElementById('storyTypeSelect');
            const chapterSelect = document.getElementById('chapterSelect');
            const volumeInput = document.getElementById('volumeInput');
            
            let shouldAutoLoad = false;

            // 2. Restore Language & Update UI strings
            if (i18n[progress.lang]) {
                langSelect.value = progress.lang;
            }
            updateI18nStrings(); 
            
            // 3. Restore Volume
            if (volumeInput) {
                const savedVolume = progress.volume !== undefined ? progress.volume : 0.5;
                volumeInput.value = savedVolume * 100;
                setVolume(savedVolume);
            }

            // 4. Restore Story Type
            if (progress.type && STORY_GROUPS[progress.type]) {
                typeSelect.value = progress.type;
                
                // 5. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤ –∏ –∂–¥–µ–º –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                await updateChapterSelect(true); 
            }
            
            // 6. Restore Chapter
            if (typeSelect.value && progress.chapter && KNOWN_CHAPTERS[progress.chapter]) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≥–ª–∞–≤–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø–æ—è–≤–∏–ª–∞—Å—å –≤ —Å–ø–∏—Å–∫–µ –ø–æ—Å–ª–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                if (Array.from(chapterSelect.options).some(opt => opt.value === progress.chapter)) {
                    chapterSelect.value = progress.chapter;
                    shouldAutoLoad = true;
                }
            }

            // 7. Auto Load Content and restore dialogue index
            if (shouldAutoLoad && progress.index !== undefined && chapterSelect.value) {
                updateStoryContent(progress.index);
            }

            enableLoadButton();
            console.log('Progress loaded and restored.');
        }

        function resetProgress() {
            localStorage.removeItem(STORAGE_KEY);
            dialogueIsLoaded = false;
            currentDialogueIndex = 0;
            currentDialogue = []; 

            document.getElementById('dialogueWrapper').classList.add('hidden');
            document.getElementById('logToggleButton').classList.add('hidden'); 
            document.getElementById('logModal').classList.add('hidden');
            document.getElementById('logContent').classList.add('translate-x-full');

            document.getElementById('languageSelect').value = 'ru';
            
            document.getElementById('volumeInput').value = 50;
            setVolume(0.5); 
            if (chapterAudio) chapterAudio.pause(); 

            initializeOrUpdateUI(); 
            const vnViewer = document.getElementById('vnViewer');
            vnViewer.style.backgroundImage = `url('${DEFAULT_BG_URL}')`;
            
            document.getElementById('spriteLeftContainer').classList.add('hidden');
            document.getElementById('spriteRightContainer').classList.add('hidden');
        }

        // --- CORE UI FUNCTIONS ---
        
        function toggleLog() {
            const modal = document.getElementById('logModal');
            const content = document.getElementById('logContent');
            const logContainer = document.getElementById('logContainer');

            if (modal.classList.contains('hidden')) {
                if (dialogueIsLoaded) {
                    populateDialogueLog();
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        content.classList.remove('translate-x-full');
                        const currentEntry = logContainer.querySelector(`.current-log-entry`);
                        if (currentEntry) {
                            currentEntry.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 10);
                }
            } else {
                content.classList.add('translate-x-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300); 
            }
        }

        function handleVnClick(event) {
            if (!dialogueIsLoaded || !document.getElementById('logModal').classList.contains('hidden') || currentDialogue.length === 0) return;
            
            const vnViewer = document.getElementById('vnViewer');
            const rect = vnViewer.getBoundingClientRect();
            const clickX = event.clientX;
            
            const relativeX = (clickX - rect.left) / rect.width;

            if (relativeX > 0.6) { 
                navigateDialogue(1);
            } else if (relativeX < 0.4) { 
                navigateDialogue(-1);
            }
        }

        function enableLoadButton() {
            const storyId = document.getElementById('chapterSelect').value;
            document.getElementById('loadButton').disabled = !storyId;
        }

        function updateI18nStrings() {
            const lang = document.getElementById('languageSelect').value;
            const text = i18n[lang];

            document.getElementById('headerTitle').textContent = text.headerTitle;
            document.getElementById('labelStoryType').textContent = text.labelStoryType;
            document.getElementById('labelChapter').textContent = text.labelChapter;
            document.getElementById('loadText').textContent = text.loadText;
            document.getElementById('resetButton').textContent = text.resetProgress;
            
            document.getElementById('helpContent').innerHTML = `
                <h4 class="text-lg font-semibold text-red-400 mb-2">${text.helpTitle}</h4>
                <p class="whitespace-pre-line">${text.helpText}</p>`;
        }

        async function initializeOrUpdateUI() {
            updateI18nStrings();
            updateStoryTypeSelect();
            await updateChapterSelect(); 
            saveProgress(); 
        }

        function updateStoryTypeSelect() {
            const select = document.getElementById('storyTypeSelect');
            const lang = document.getElementById('languageSelect').value;
            const currentType = select.value;
            
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "---";
            select.appendChild(defaultOption);

            for (const key in STORY_GROUPS) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = STORY_GROUPS[key][lang];
                if (key === currentType) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        /** Populates the Chapter dropdown based on the selected Story Type and *actual file existence*. */
        async function updateChapterSelect(skipSideEffects = false) {
            const typeKey = document.getElementById('storyTypeSelect').value;
            const select = document.getElementById('chapterSelect');
            const lang = document.getElementById('languageSelect').value;
            const currentChapterKey = select.value; 

            select.innerHTML = '';
            select.disabled = true;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "---";
            select.appendChild(defaultOption);

            const loadButton = document.getElementById('loadButton');
            const originalLoadText = i18n[lang].loadText;

            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø, –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
            if (typeKey && STORY_GROUPS[typeKey]) {
                loadButton.textContent = i18n[lang].loadingCheck;
                loadButton.disabled = true; 

                const prefix = STORY_GROUPS[typeKey].prefix;
                const chaptersToCheck = Object.keys(KNOWN_CHAPTERS).filter(key => key.startsWith(prefix));

                // –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –≥–ª–∞–≤
                const availabilityChecks = chaptersToCheck.map(key => 
                    checkChapterAvailability(key, lang).then(isAvailable => ({ key, isAvailable }))
                );

                const results = await Promise.all(availabilityChecks);

                let chapterFound = false;

                results.forEach(({ key, isAvailable }) => {
                    if (isAvailable) {
                        const fullChapterKey = key;
                        const chapterData = KNOWN_CHAPTERS[fullChapterKey];

                        if (chapterData && chapterData[lang]) {
                            const option = document.createElement('option');
                            option.value = fullChapterKey; 
                            option.textContent = chapterData[lang]; 
                            
                            if (fullChapterKey === currentChapterKey) {
                                 option.selected = true;
                            }
                            select.appendChild(option);
                            chapterFound = true;
                        }
                    }
                });
                
                if (chapterFound) {
                     select.disabled = false;
                }
            } 
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏
            loadButton.textContent = originalLoadText;
            
            if (!skipSideEffects) {
                enableLoadButton();
                saveProgress(); 
            }
        }

        /** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥–ª–∞–≤—É —Å—é–∂–µ—Ç–∞. */
        async function updateStoryContent(startIndex = 0) {
            const lang = document.getElementById('languageSelect').value; 
            const fullStoryKey = document.getElementById('chapterSelect').value; 
            
            if (!fullStoryKey) {
                console.error("Story chapter is not selected.");
                return;
            }

            const filePath = `${STORY_BASE_PATH}${lang}/${fullStoryKey}.json`;
            console.log(`[Load] –ó–∞–ø—Ä–æ—Å —Ñ–∞–π–ª–∞: ${filePath}`);

            document.getElementById('loadText').textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            document.getElementById('loadButton').disabled = true;


            try {
                const maxRetries = 3;
                let response;
                
                // Fetch with Exponential Backoff
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(filePath);
                        if (response.ok) {
                            break; 
                        }
                    } catch (error) {
                        console.warn(`[Load] –ü–æ–ø—ã—Ç–∫–∞ ${i + 1} –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –Ω–µ—É–¥–∞—á–µ–π. –ü–æ–≤—Ç–æ—Ä...`);
                    }
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        throw new Error("–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ.");
                    }
                }

                if (!response || !response.ok) {
                    throw new Error(`HTTP error! status: ${response ? response.status : 'unknown'}`);
                }

                const data = await response.json();
                
                // --- SUCCESS: Update Global State ---
                currentDialogue = data.dialogue || [];
                currentDialogueIndex = Math.min(startIndex, currentDialogue.length - 1);
                currentDialogueIndex = Math.max(0, currentDialogueIndex); 
                dialogueIsLoaded = true;

                // --- UI Updates ---
                document.getElementById('dialogueWrapper').classList.remove('hidden');
                document.getElementById('logToggleButton').classList.remove('hidden'); 
                document.getElementById('loadText').textContent = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ";
                
                playChapterAudio(data.audio_track);

                // Initialize the scene
                renderDialogueStep();

            } catch (e) {
                console.error("Failed to load dialogue data:", e);
                document.getElementById('loadText').textContent = i18n[document.getElementById('languageSelect').value].errorFetch; 
                setTimeout(() => {
                    document.getElementById('loadText').textContent = i18n[document.getElementById('languageSelect').value].loadText;
                }, 4000);
                dialogueIsLoaded = false;
                currentDialogue = [];
            } finally {
                setTimeout(() => {
                    document.getElementById('loadButton').disabled = false;
                }, 500);
            }
        }

        /** Renders the current dialogue step and updates the UI. */
        function renderDialogueStep() {
            if (!dialogueIsLoaded || currentDialogue.length === 0) {
                document.getElementById('dialogueWrapper').classList.add('hidden');
                document.getElementById('logToggleButton').classList.add('hidden');
                return;
            }

            const step = currentDialogue[currentDialogueIndex];
            const vnViewer = document.getElementById('vnViewer');
            const currentSpeakerElement = document.getElementById('currentSpeaker');
            const currentTextElement = document.getElementById('currentText');

            // 1. Background
            if (step.background) {
                vnViewer.style.backgroundImage = `url('${step.background}')`;
            } else if (currentDialogueIndex === 0) {
                 vnViewer.style.backgroundImage = `url('${DEFAULT_BG_URL}')`;
            } 

            // --- 2. Sprites & Dimming (FIXED LOGIC) ---
            
            const activeSpeakerPosition = (step.speaker && step.position) ? step.position.toLowerCase() : null;
            const dimmedSpriteFilename = step.sprite_dimmed ? step.sprite_dimmed.trim() : null;

            // 2a. Handle Sprite updates (only if a new sprite is explicitly defined).
            if (step.sprite && step.position) {
                const isLeft = step.position.toLowerCase() === 'left';
                const container = isLeft ? spriteLeftContainer : spriteRightContainer;
                const imageElement = isLeft ? spriteLeftElement : spriteRightElement;
                
                let spriteFileName = step.sprite.trim(); 
                let spritePath = spriteFileName.startsWith('http') ? spriteFileName : SPRITE_BASE_PATH + spriteFileName;

                // Load/Show sprite (makes it persistent until a new one replaces it)
                if (imageElement.src !== spritePath) {
                    imageElement.src = spritePath;
                }
                container.classList.remove('hidden');
            } 
            // Note: If step.sprite is missing, the previous sprite is assumed to persist visually.

            // 2b. Reset dimming for all, then apply new dimming rules.
            spriteLeftElement.classList.remove('dimmed-sprite');
            spriteRightElement.classList.remove('dimmed-sprite');
            
            // 2c. Apply Dimming Rules
            
            // Rule 1: Apply dimming if explicitly requested (e.g., narration/SFX steps).
            if (dimmedSpriteFilename) {
                // Check Left Sprite
                if (!spriteLeftContainer.classList.contains('hidden') && spriteLeftElement.src.includes(dimmedSpriteFilename)) {
                    spriteLeftElement.classList.add('dimmed-sprite');
                }
                // Check Right Sprite
                if (!spriteRightContainer.classList.contains('hidden') && spriteRightElement.src.includes(dimmedSpriteFilename)) {
                    spriteRightElement.classList.add('dimmed-sprite');
                }
            }

            // Rule 2: Classic VN Dimming - Dim non-speaking characters.
            if (activeSpeakerPosition) {
                // Ensure the active speaker is BRIGHT
                if (activeSpeakerPosition === 'left' && !spriteLeftContainer.classList.contains('hidden')) {
                    spriteLeftElement.classList.remove('dimmed-sprite'); // Active speaker bright
                } else if (activeSpeakerPosition === 'right' && !spriteRightContainer.classList.contains('hidden')) {
                    spriteRightElement.classList.remove('dimmed-sprite'); // Active speaker bright
                }
                
                // Ensure non-active sprites are DIMMED (unless already dimmed by Rule 1)
                if (activeSpeakerPosition === 'right' && !spriteLeftContainer.classList.contains('hidden')) {
                    spriteLeftElement.classList.add('dimmed-sprite'); // Non-speaker dim
                } else if (activeSpeakerPosition === 'left' && !spriteRightContainer.classList.contains('hidden')) {
                    spriteRightElement.classList.add('dimmed-sprite'); // Non-speaker dim
                }
            } 
            // End of Sprite Logic

            // 3. Dialogue Text and Speaker Name
            // –ò–º—è –≥–æ–≤–æ—Ä—è—â–µ–≥–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ, –Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–∏–∞–ª–æ–≥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º.
            if (step.speaker && step.speaker !== '') {
                currentSpeakerElement.textContent = step.speaker;
                currentSpeakerElement.parentElement.style.opacity = '1';
            } else {
                // –ü–û–í–ï–°–¢–í–û–í–ê–ù–ò–ï: –∏–º—è –≥–æ–≤–æ—Ä—è—â–µ–≥–æ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è.
                currentSpeakerElement.textContent = '';
                currentSpeakerElement.parentElement.style.opacity = '0'; 
            }
            
            currentTextElement.textContent = step.text || ' ';

            // 4. Save Progress
            saveProgress();
        }

        function navigateDialogue(direction) {
            let newIndex = currentDialogueIndex + direction;
            
            if (newIndex >= 0 && newIndex < currentDialogue.length) {
                currentDialogueIndex = newIndex;
                renderDialogueStep();
            } else if (newIndex >= currentDialogue.length) {
                console.log("End of chapter reached.");
            } else if (newIndex < 0) {
                 console.log("Beginning of chapter reached.");
                 currentDialogueIndex = 0; 
                 renderDialogueStep();
            }
        }

        function populateDialogueLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = ''; 

            currentDialogue.forEach((step, index) => {
                if (step.text) {
                    const entry = document.createElement('div');
                    entry.className = `log-entry ${index === currentDialogueIndex ? 'current-log-entry' : ''}`;
                    entry.onclick = () => {
                        currentDialogueIndex = index;
                        renderDialogueStep();
                        toggleLog(); 
                    };

                    if (step.speaker) {
                        const speaker = document.createElement('span');
                        speaker.className = 'log-speaker';
                        speaker.textContent = step.speaker;
                        entry.appendChild(speaker);
                    }

                    const text = document.createElement('p');
                    text.className = 'log-text';
                    text.textContent = step.text;
                    entry.appendChild(text);
                    
                    logContainer.appendChild(entry);
                }
            });
             if (logContainer.innerHTML === '') {
                 logContainer.innerHTML = '<p class="text-gray-500 text-center mt-8">–õ–æ–≥ –ø—É—Å—Ç.</p>';
             }
        }

        function showHelpModal() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('hidden');
        }

        // --- INITIALIZATION ---
        window.onload = function() {
            // Get element references once
            spriteLeftContainer = document.getElementById('spriteLeftContainer');
            spriteRightContainer = document.getElementById('spriteRightContainer');
            spriteLeftElement = document.getElementById('spriteLeft');
            spriteRightElement = document.getElementById('spriteRight');
            chapterAudio = document.getElementById('chapterAudio');

            // Setup event listeners
            document.getElementById('volumeInput').addEventListener('input', handleVolumeChange);
            document.getElementById('languageSelect').addEventListener('change', initializeOrUpdateUI);
            document.getElementById('storyTypeSelect').addEventListener('change', initializeOrUpdateUI);
            
            // Initial UI setup and progress check
            loadProgress(); // –¢–µ–ø–µ—Ä—å loadProgress –≤—ã–∑—ã–≤–∞–µ—Ç initializeOrUpdateUI –∏ –∂–¥–µ—Ç –µ–µ
        };

    </script>
</body>
</html>
