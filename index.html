<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Houkai Gakuen 2 Архив Сюжета</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Custom Dark Theme -->
    <!-- Application Structure Plan: SPA с фиксированным заголовком, содержащим название и переключатель языка. Основная область содержит три зависимых выпадающих списка (Тип сюжета -> Сюжет -> Этап) для навигации. При выборе сюжета, приложение асинхронно загружает соответствующий JSON-файл из папки story/. Ниже расположена область динамического контента, которая отображает выбранный этап в формате визуальной новеллы. -->
    <!-- Visualization & Content Choices: Информация: Архив сюжетов игры. Цель: Навигация и чтение с внешней загрузкой данных. Метод представления: HTML-селекторы для фильтрации и динамически обновляемый div для отображения текста. Взаимодействие: Выбор сюжета запускает fetch() для загрузки JSON-файла. Выбор этапа отображает нужный блок диалога из загруженных данных. Обоснование: Внешняя загрузка позволяет легко добавлять новый контент без редактирования основного HTML-файла. Библиотека: Vanilla JS для логики (включая Fetch API), Tailwind CSS для стилей. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            background-color: #5c5c5c;
            color: #f0f0f0;
            font-family: 'Inter', sans-serif;
        }
        .header {
            background-color: #2a2a2a;
        }
        .custom-select {
            background-color: #3a3a3a;
            border-color: #7a7a7a;
            color: #f0f0f0;
        }
        .story-container {
            background-size: cover;
            background-position: center;
            min-height: 60vh;
        }
        .dialogue-box {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        .character-sprite {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            max-height: 85vh;
        }
        .sprite-left {
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="min-h-screen">

    <header class="header shadow-lg p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 id="main-title" class="text-xl md:text-2xl font-bold text-white">Houkai Gakuen 2 архив сюжета</h1>
        <div class="relative">
            <select id="language-selector" class="custom-select rounded-md py-2 px-3 appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-pink-500">
                <option value="ru">Русский</option>
                <option value="en">English</option>
                <option value="cn">中文</option>
            </select>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="bg-gray-800 bg-opacity-50 p-6 rounded-lg shadow-xl mb-8">
            <p id="intro-text" class="text-center mb-6 text-lg">Добро пожаловать в архив сюжета Houkai Gakuen 2. Выберите тип сюжета, главу и этап, чтобы начать чтение.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label id="label-story-type" for="story-type-selector" class="block mb-2 text-sm font-medium">Тип сюжета</label>
                    <select id="story-type-selector" class="custom-select w-full rounded-md p-2.5 focus:outline-none focus:ring-2 focus:ring-pink-500"></select>
                </div>
                <div>
                    <label id="label-story" for="story-selector" class="block mb-2 text-sm font-medium">Сюжет</label>
                    <select id="story-selector" class="custom-select w-full rounded-md p-2.5 focus:outline-none focus:ring-2 focus:ring-pink-500" disabled></select>
                </div>
                <div>
                    <label id="label-stage" for="stage-selector" class="block mb-2 text-sm font-medium">Этап</label>
                    <select id="stage-selector" class="custom-select w-full rounded-md p-2.5 focus:outline-none focus:ring-2 focus:ring-pink-500" disabled></select>
                </div>
            </div>
        </div>

        <div id="loading-indicator" class="text-center text-pink-400 font-bold text-xl my-8 hidden">
            Загрузка сюжета...
        </div>

        <div id="story-display" class="hidden">
             <div class="story-container w-full rounded-lg shadow-2xl flex flex-col justify-end items-center p-4 relative overflow-hidden">
                <div id="character-display" class="absolute inset-0 flex justify-center items-end">
                     <img id="sprite-left" src="" alt="Спрайт персонажа слева" class="character-sprite sprite-left opacity-0 h-full object-contain object-bottom" style="max-width: 40%;">
                     <img id="sprite-right" src="" alt="Спрайт персонажа справа" class="character-sprite h-full object-contain object-bottom opacity-0" style="max-width: 40%;">
                </div>
                <div id="dialogue-container" class="dialogue-box w-full max-w-4xl p-6 rounded-lg relative z-10 text-center hidden">
                    <h3 id="speaker-name" class="text-2xl font-bold text-pink-400 mb-2"></h3>
                    <p id="dialogue-text" class="text-lg leading-relaxed"></p>
                    <div class="flex justify-center mt-4 gap-4">
                        <button id="prev-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"></button>
                        <button id="next-btn" class="bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const i18n = {
            ru: {
                mainTitle: "Houkai Gakuen 2 архив сюжета",
                introText: "Добро пожаловать в архив сюжета Houkai Gakuen 2. Выберите тип сюжета, главу и этап, чтобы начать чтение.",
                labels: {
                    storyType: "Тип сюжета",
                    story: "Сюжет",
                    stage: "Этап",
                },
                buttons: {
                    prev: "Назад",
                    next: "Далее",
                },
                placeholders: {
                    select: "Выберите...",
                    story: "Сначала выберите тип",
                    stage: "Сначала выберите сюжет"
                },
                storyTypes: {
                    main: "Основной сюжет",
                    extra: "Дополнительный сюжет",
                    boss: "Боссы",
                    vn: "Визуальная новелла",
                    novel: "Роман"
                },
            },
            en: {
                mainTitle: "Houkai Gakuen 2 Story Archive",
                introText: "Welcome to the Houkai Gakuen 2 Story Archive. Select a story type, chapter, and stage to start reading.",
                labels: {
                    storyType: "Story Type",
                    story: "Story",
                    stage: "Stage",
                },
                buttons: {
                    prev: "Previous",
                    next: "Next",
                },
                placeholders: {
                    select: "Select...",
                    story: "Select a type first",
                    stage: "Select a story first"
                },
                storyTypes: {
                    main: "Main Story",
                    extra: "Extra Story",
                    boss: "Bosses",
                    vn: "Visual Novel",
                    novel: "Novel"
                },
            },
            cn: {
                mainTitle: "崩坏学园2剧情档案",
                introText: "欢迎来到崩坏学园2剧情档案。请选择故事类型、章节和关卡开始阅读。",
                labels: {
                    storyType: "故事类型",
                    story: "剧情",
                    stage: "关卡",
                },
                buttons: {
                    prev: "上一页",
                    next: "下一页",
                },
                placeholders: {
                    select: "请选择...",
                    story: "请先选择类型",
                    stage: "请先选择剧情"
                },
                storyTypes: {
                    main: "主线剧情",
                    extra: "支线剧情",
                    boss: "首领",
                    vn: "视觉小说",
                    novel: "小说"
                },
            }
        };

        // Story structure now primarily defines the dropdowns.
        // The actual content (dialogue/backgrounds) will be loaded from external files.
        const storyData = {
            main: {
                "ch1": { 
                    ru: "Глава 1: Выброс Хоукая", 
                    en: "Chapter 1: Houkai Outbreak", 
                    cn: "第1章：崩坏爆发",
                    stages: {
                        "s1": { ru: "1-1", en: "1-1", cn: "1-1" },
                        "s2": { ru: "1-2", en: "1-2", cn: "1-2" },
                        "s3": { ru: "1-3", en: "1-3", cn: "1-3" },
                    }
                },
                "ch2": { 
                    ru: "Глава 2: Киана наносит ответный удар", 
                    en: "Chapter 2: Kiana Strikes Back", 
                    cn: "第2章：琪亚娜反击",
                    stages: {
                        "s1": { ru: "2-1", en: "2-1", cn: "2-1" },
                        "s2": { ru: "2-2", en: "2-2", cn: "2-2" },
                    }
                },
                 "ch3": { 
                    ru: "Глава 3: Зловещая молния", 
                    en: "Chapter 3: Sinister Lightning", 
                    cn: "第3章：不祥的闪电",
                    stages: {
                        "s1": { ru: "3-1", en: "3-1", cn: "3-1" },
                    }
                },
            },
            extra: {
                "ex1": { 
                    ru: "Экстра 1: Берегись", 
                    en: "Extra 1: Beware", 
                    cn: "额外1：当心",
                    stages: {
                        "s1": { ru: "Э1-1", en: "E1-1", cn: "附1-1" },
                    }
                },
                "ex2": { 
                    ru: "Экстра 2: Неутолимое желание", 
                    en: "Extra 2: Insatiable Desire", 
                    cn: "额外2：永不满足的欲望",
                     stages: {
                        "s1": { ru: "Э2-1", en: "E2-1", cn: "附2-1" },
                        "s2": { ru: "Э2-2", en: "E2-2", cn: "附2-2" },
                    }
                }
            },
            boss: {},
            vn: {},
            novel: {}
        };
        
        let currentLang = 'ru';
        let currentDialogueIndex = 0;
        let fetchedStoryContent = null; 
        let currentStageKey = null; // Key of the currently selected stage (s1, s2, etc.)
        let currentContentPath = '';

        const langSelector = document.getElementById('language-selector');
        const mainTitle = document.getElementById('main-title');
        const introText = document.getElementById('intro-text');
        const labelStoryType = document.getElementById('label-story-type');
        const labelStory = document.getElementById('label-story');
        const labelStage = document.getElementById('label-stage');
        const storyTypeSelector = document.getElementById('story-type-selector');
        const storySelector = document.getElementById('story-selector');
        const stageSelector = document.getElementById('stage-selector');
        const loadingIndicator = document.getElementById('loading-indicator');
        const storyDisplay = document.getElementById('story-display');
        const storyContainer = storyDisplay.querySelector('.story-container');
        const dialogueContainer = document.getElementById('dialogue-container');
        const speakerName = document.getElementById('speaker-name');
        const dialogueText = document.getElementById('dialogue-text');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const spriteLeft = document.getElementById('sprite-left');
        const spriteRight = document.getElementById('sprite-right');

        function updateUI() {
            const t = i18n[currentLang];
            mainTitle.textContent = t.mainTitle;
            introText.textContent = t.introText;
            labelStoryType.textContent = t.labels.storyType;
            labelStory.textContent = t.labels.story;
            labelStage.textContent = t.labels.stage;
            prevBtn.textContent = t.buttons.prev;
            nextBtn.textContent = t.buttons.next;

            populateStoryTypes();
            populateStories();
            populateStages();
            
            if(fetchedStoryContent) {
                renderDialogue();
            }
        }

        function populateStoryTypes() {
            const t = i18n[currentLang];
            const selectedValue = storyTypeSelector.value;
            storyTypeSelector.innerHTML = `<option value="">${t.placeholders.select}</option>`;
            for (const typeKey in t.storyTypes) {
                const option = document.createElement('option');
                option.value = typeKey;
                option.textContent = t.storyTypes[typeKey];
                storyTypeSelector.appendChild(option);
            }
            storyTypeSelector.value = selectedValue;
        }

        function populateStories() {
            const t = i18n[currentLang];
            const storyType = storyTypeSelector.value;
            const selectedValue = storySelector.value;
            storySelector.innerHTML = '';

            if (!storyType) {
                storySelector.innerHTML = `<option value="">${t.placeholders.story}</option>`;
                storySelector.disabled = true;
                return;
            }
            
            storySelector.disabled = false;
            storySelector.innerHTML = `<option value="">${t.placeholders.select}</option>`;
            const stories = storyData[storyType];
            for (const storyKey in stories) {
                const option = document.createElement('option');
                option.value = storyKey;
                option.textContent = stories[storyKey][currentLang];
                storySelector.appendChild(option);
            }
            storySelector.value = selectedValue;
        }
        
        function populateStages() {
            const t = i18n[currentLang];
            const storyType = storyTypeSelector.value;
            const story = storySelector.value;
            const selectedValue = stageSelector.value;
            stageSelector.innerHTML = '';

            if (!storyType || !story) {
                stageSelector.innerHTML = `<option value="">${t.placeholders.stage}</option>`;
                stageSelector.disabled = true;
                return;
            }

            stageSelector.disabled = false;
            stageSelector.innerHTML = `<option value="">${t.placeholders.select}</option>`;
            const stages = storyData[storyType][story]?.stages;
            if (stages) {
                for (const stageKey in stages) {
                    const option = document.createElement('option');
                    option.value = stageKey;
                    option.textContent = stages[stageKey][currentLang];
                    stageSelector.appendChild(option);
                }
            }
            stageSelector.value = selectedValue;
        }

        async function fetchStoryContent(type, storyKey) {
            if (!type || !storyKey) return;
            
            const filePath = `story/${type}_${storyKey}.json`;
            
            if (filePath === currentContentPath && fetchedStoryContent) {
                return true; 
            }

            loadingIndicator.classList.remove('hidden');
            storyDisplay.classList.add('hidden');
            dialogueContainer.classList.add('hidden');
            
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Не удалось загрузить файл сюжета: ${filePath}`);
                }
                fetchedStoryContent = await response.json();
                currentContentPath = filePath;
                return true;
            } catch (error) {
                console.error(error);
                loadingIndicator.textContent = `Ошибка загрузки: ${filePath}. Проверьте, существует ли файл.`;
                fetchedStoryContent = null;
                return false;
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        async function displayStage() {
            const storyType = storyTypeSelector.value;
            const story = storySelector.value;
            const stage = stageSelector.value;
            currentStageKey = stage;

            if (!storyType || !story || !stage) {
                storyDisplay.classList.add('hidden');
                dialogueContainer.classList.add('hidden');
                return;
            }
            
            const contentLoaded = await fetchStoryContent(storyType, story);

            if (contentLoaded && fetchedStoryContent && fetchedStoryContent[currentStageKey]) {
                const currentStageData = fetchedStoryContent[currentStageKey];
                
                storyDisplay.classList.remove('hidden');
                storyContainer.style.backgroundImage = `url('${currentStageData.background}')`;
                currentDialogueIndex = 0;
                renderDialogue();
                dialogueContainer.classList.remove('hidden');
            } else {
                storyDisplay.classList.add('hidden');
                dialogueContainer.classList.add('hidden');
            }
        }

        function renderDialogue() {
            if (!fetchedStoryContent || !currentStageKey) return;

            const currentStageData = fetchedStoryContent[currentStageKey];

            if (!currentStageData || !currentStageData.dialogue) return;

            const dialogue = currentStageData.dialogue[currentDialogueIndex];
            
            speakerName.textContent = dialogue.speaker[currentLang] || '';
            dialogueText.textContent = dialogue.text[currentLang] || '';
            
            // Сброс спрайтов
            spriteLeft.style.opacity = 0;
            spriteRight.style.opacity = 0;

            if (dialogue.sprite) {
                // Используем здесь путь images/sprites/
                const spriteUrl = `images/sprites/${dialogue.sprite}`; 
                if (dialogue.position === 'left') {
                    spriteLeft.src = spriteUrl;
                    spriteLeft.style.opacity = 1;
                } else if (dialogue.position === 'right') {
                    spriteRight.src = spriteUrl;
                    spriteRight.style.opacity = 1;
                }
            }

            prevBtn.disabled = currentDialogueIndex === 0;
            nextBtn.disabled = currentDialogueIndex === currentStageData.dialogue.length - 1;
        }

        langSelector.addEventListener('change', (e) => {
            currentLang = e.target.value;
            updateUI();
        });

        storyTypeSelector.addEventListener('change', () => {
            storySelector.value = '';
            stageSelector.value = '';
            fetchedStoryContent = null;
            currentContentPath = '';
            populateStories();
            populateStages();
            displayStage(); 
        });
        
        storySelector.addEventListener('change', () => {
            stageSelector.value = '';
            fetchedStoryContent = null;
            currentContentPath = '';
            populateStages();
            // На этом этапе нужно только загрузить контент, но не отображать его, пока не выбран этап
            // Вызываем displayStage, чтобы загрузить файл, но он не отобразит ничего, пока stageSelector пуст.
            displayStage(); 
        });

        stageSelector.addEventListener('change', displayStage);

        prevBtn.addEventListener('click', () => {
            if (currentDialogueIndex > 0) {
                currentDialogueIndex--;
                renderDialogue();
            }
        });

        nextBtn.addEventListener('click', () => {
            const currentStageData = fetchedStoryContent ? fetchedStoryContent[currentStageKey] : null;
            if (currentStageData && currentDialogueIndex < currentStageData.dialogue.length - 1) {
                currentDialogueIndex++;
                renderDialogue();
            }
        });
        
        updateUI();
    </script>
</body>
</html>
