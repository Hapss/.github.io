<!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ –ù–æ–≤–µ–ª–ª —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ª–æ–≥–∏–∫–∏ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —Å–ø—Ä–∞–π—Ç–æ–≤, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–º–µ–Ω—ã —Ç–µ–º—ã, –∏—Å—Ç–æ—Ä–∏–µ–π –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —è–∑—ã–∫–æ–≤ -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞ Houkai Gakuen 2</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ==================================================================== */
        /* === –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Dark Theme - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) === */
        /* ==================================================================== */
        :root, .dark-theme {
            /* –§–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ */
            --color-bg-darkest: #171c26; /* –î–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ */
            --color-bg-main: #1f2937;    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω/—ç–ª–µ–º–µ–Ω—Ç—ã (VN Viewer default) */
            --color-bg-medium: #374151;  /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–§–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
            
            /* –ê–∫—Ü–µ–Ω—Ç—ã */
            --color-accent-primary: #0891b2; /* –ë–∏—Ä—é–∑–æ–≤—ã–π (Load button / –ê–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏) */
            --color-accent-secondary: #0e7490; /* –¢–µ–º–Ω—ã–π –ë–∏—Ä—é–∑–æ–≤—ã–π (Reset button) */
            --color-accent-ring: #22d3ee; /* –°–≤–µ—Ç–ª—ã–π –ë–∏—Ä—é–∑–æ–≤—ã–π (Focus/Hover ring) */
            
            /* –¢–µ–∫—Å—Ç */
            --color-text-primary: #e5e7eb; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            --color-text-secondary: #d1d5db; /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç */
            
            /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–ù–µ —Ç—Ä–æ–Ω—É—Ç) */
            --color-speaker-name: #ca7cfe; 
        }

        /* ==================================================================== */
        /* === –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Light Theme) - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ === */
        /* ==================================================================== */
        .light-theme {
            /* –§–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ */
            --color-bg-darkest: #ffffff;  /* –°–∞–º—ã–π —Å–≤–µ—Ç–ª—ã–π Header –∏ –∏—Å—Ç–æ—Ä–∏—è */
            --color-bg-main: #f3f4f6;    /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω (VN Viewer default) */
            --color-bg-medium: #ffffff;  /* Control Panel/–§–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
            
            /* –ê–∫—Ü–µ–Ω—Ç—ã */
            --color-accent-primary: #0f766e; /* –¢–µ–º–Ω—ã–π –ë–∏—Ä—é–∑–æ–≤—ã–π (–ê–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏) */
            --color-accent-secondary: #115e59; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π (Reset button) */
            --color-accent-ring: #0d9488; /* –ê–∫—Ü–µ–Ω—Ç –¥–ª—è —Ñ–æ–∫—É—Å–∞ */
            
            /* –¢–µ–∫—Å—Ç - –£–õ–£–ß–®–ï–ù–ù–´–ô –ö–û–ù–¢–†–ê–°–¢ */
            --color-text-primary: #111827; /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
            --color-text-secondary: #4b5563; /* –°—Ä–µ–¥–Ω–µ-—Ç–µ–º–Ω—ã–π —Ç–µ–∫—Å—Ç */
            
            /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (–°–¥–µ–ª–∞–Ω —Ç–µ–º–Ω–µ–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –Ω–∞ —Å–≤–µ—Ç–ª–æ–º —Ñ–æ–Ω–µ) */
            --color-speaker-name: #9333ea; 
        }

        /* ==================================================================== */
        /* === –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º === */
        /* ==================================================================== */
        
        body, #vnViewer, .sprite-image {
            user-select: none;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-drag: none;
            -webkit-user-drag: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-main); 
            color: var(--color-text-primary);
            transition: background-color 0.3s ease;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è UI-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .vn-overlay {
            /* –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Å –ª–µ–≥–∫–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
            background-color: var(--color-bg-main); 
            opacity: 0.9;
            backdrop-filter: blur(4px);
            color: var(--color-text-primary);
            border: 1px solid var(--color-bg-medium); /* –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–Ω–∫—É—é –≥—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã */
        }
        .speaker-name {
            background-color: var(--color-bg-main);
            color: var(--color-speaker-name); 
            padding: 4px 12px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: inline-block;
            font-weight: bold;
            font-size: 1.25rem;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ —Å–µ–ª–µ–∫—Ç—ã */
        .control-panel { background-color: var(--color-bg-medium); }
        .select-field { 
            /* –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–º—ã, –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—è Tailwind */
            color: var(--color-text-primary); 
            background-color: var(--color-bg-main); 
            -webkit-appearance: none; /* –°–±—Ä–æ—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å—Ç–∏–ª—è –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è */
            appearance: none;
        }
        .select-field:hover, .select-field:focus { 
            box-shadow: 0 0 0 2px var(--color-accent-ring);
            border-color: var(--color-accent-ring);
        }
        
        /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .reset-button { background-color: var(--color-accent-secondary); }
        .reset-button:hover { background-color: var(--color-accent-primary); }
        .load-button { background-color: var(--color-accent-primary); }
        .load-button:hover { background-color: var(--color-accent-secondary); }
        .alert-message { background-color: var(--color-accent-primary); }


        /* ==================================================================== */
        /* === –°–ø—Ä–∞–π—Ç—ã –∏ –§–æ–Ω === */
        /* ==================================================================== */
        
        /* Sprite Container –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å #vnViewer */
        .sprite-position {
            position: absolute;
            bottom: 0; /* –ü—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–∞–º–æ–º—É –Ω–∏–∑—É #vnViewer */
            height: 95%; 
            width: 45%;
            transition: opacity 0.5s ease; 
            z-index: 10;
            display: flex; 
            justify-content: center;
            align-items: flex-end;
        }
        .sprite-position.left { left: 0; }
        .sprite-position.right { right: 0; }
        
        .sprite-image {
            height: 100%; 
            width: auto;
            max-height: 100%; 
            object-fit: contain;
            display: block; 
            /* –°—Ç–∏–ª—å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è: —Ç–µ–ø–µ—Ä—å opacity –∏ filter */
            transition: opacity 0.3s ease, filter 0.3s ease; 
            opacity: 1; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–ª–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å */
        }
        
        /* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–∞—Ç–µ–º–Ω—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª–Ω—É—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
        .dimmed-sprite {
            /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —è—Ä–∫–æ—Å—Ç–∏ –¥–æ 30% –∏ –ª–µ–≥–∫–æ–µ –æ–±–µ—Å—Ü–≤–µ—á–∏–≤–∞–Ω–∏–µ */
            filter: brightness(0.3) grayscale(30%) !important; 
            opacity: 1 !important; /* –í–∞–∂–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω—É—é –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
        }
        
        .bg-layer {
            transition: opacity 1.0s ease; 
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }
        #vnViewer {
            background-color: var(--color-bg-main); 
        }

        /* ==================================================================== */
        /* === –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–û–í (–û–ë–ù–û–í–õ–ï–ù–ò–ï: –í–ü–†–ê–í–û, –®–ò–†–ï, –°–ö–†–û–õ–õ–ë–ê–†) === */
        /* ==================================================================== */
        
        #historyPanel.open {
            transform: translateX(0); /* –ü–æ–∫–∞–∑–∞—Ç—å: –≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –º–µ—Å—Ç–æ */
        }
        #historyPanel {
            /* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∞ */
            right: 0; 
            left: auto; /* –û—Ç–º–µ–Ω—è–µ–º –ª–µ–≤—É—é –ø—Ä–∏–≤—è–∑–∫—É */
            top: 0;
            
            /* –°–∫—Ä—ã—Ç—å: —Å–¥–≤–∏–Ω—É—Ç—å –≤–ø—Ä–∞–≤–æ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞ */
            transform: translateX(100%); 
            transition: transform 0.3s ease; 
            z-index: 50; /* –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            
            /* –®–∏—Ä–∏–Ω–∞ */
            width: 100%; 
            max-width: 320px; /* –î–µ—Ñ–æ–ª—Ç –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            
            /* Flexbox –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #historyPanel {
                width: 400px; /* –®–∏—Ä–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
                max-width: none;
            }
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∑–∞–Ω–∏–º–∞—é—â–∏–π –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
        #historyContent {
            flex-grow: 1; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –∑–∞–Ω—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ */
            overflow-y: auto; /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
            padding-bottom: 2rem; /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π Scrollbar */
        #historyContent::-webkit-scrollbar {
            width: 8px;
        }

        #historyContent::-webkit-scrollbar-track {
            background: var(--color-bg-medium);
            border-radius: 10px;
        }

        #historyContent::-webkit-scrollbar-thumb {
            background: var(--color-accent-primary);
            border-radius: 10px;
            /* –û–±–≤–æ–¥–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –º–µ–∂–¥—É –ø–æ–ª–∑—É–Ω–∫–æ–º –∏ —Ç—Ä–µ–∫–æ–º */
            border: 2px solid var(--color-bg-darkest); 
        }

        #historyContent::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent-secondary);
        }
    </style>
</head>
<body class="min-h-screen dark-theme">
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                getFirestore(app);

                async function authenticate() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("[Firebase] –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                    }
                }
                authenticate();
            } catch (e) {
                console.error("[Firebase] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            }
        }
    </script>
    
    <!-- 1. Header Bar: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç var(--color-bg-darkest) -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 p-4 shadow-xl text-white transition-colors duration-300" style="background-color: var(--color-bg-darkest);">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 id="headerTitle" class="text-xl font-bold tracking-wider" style="color: var(--color-text-primary);">–ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞ Houkai Gakuen 2</h1>
            
            <div class="flex items-center space-x-4">
                 <!-- –ö–Ω–æ–ø–∫–∞ –ò—Å—Ç–æ—Ä–∏–∏ -->
                <button id="historyToggle" onclick="toggleHistory()" class="px-3 py-1 text-sm rounded-full transition duration-150" style="background-color: var(--color-bg-medium); color: var(--color-text-primary);">
                    <span id="historyText">–ò—Å—Ç–æ—Ä–∏—è</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã -->
                <button id="themeToggle" onclick="toggleTheme()" class="px-3 py-1 text-sm rounded-full transition duration-150" style="background-color: var(--color-bg-medium); color: var(--color-text-primary);">
                    <span id="themeIcon">üåô</span> <span id="themeText">–¢—ë–º–Ω–∞—è</span>
                </button>

                <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
                <button id="resetButton" onclick="resetProgress()" class="px-3 py-1 reset-button rounded-full transition duration-150 text-sm">–°–±—Ä–æ—Å</button>
                
                <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ (–£–¥–∞–ª–µ–Ω –∫–ª–∞—Å—Å text-white) -->
                <select id="languageSelect" onchange="initializeOrUpdateUI(true)" class="select-field rounded-lg p-2 cursor-pointer transition hover:ring-2" style="background-color: var(--color-bg-medium);">
                    <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                    <option value="en">English</option>
                    <option value="zh">‰∏≠Êñá (Chinese)</option>
                </select>
            </div>
        </div>
    </header>
    
    <!-- –ü–∞–Ω–µ–ª—å –ò—Å—Ç–æ—Ä–∏–∏ –î–∏–∞–ª–æ–≥–æ–≤ (–ü–ï–†–ï–ú–ï–©–ï–ù–ê –í–ü–†–ê–í–û) -->
    <div id="historyPanel" class="fixed top-0 h-full z-50 p-4 pt-20 shadow-2xl transition-transform duration-300" 
         style="background-color: var(--color-bg-darkest); opacity: 0.95;">
        <h2 id="historyTitle" class="text-xl font-bold mb-4" style="color: var(--color-text-primary);">–ò—Å—Ç–æ—Ä–∏—è –î–∏–∞–ª–æ–≥–æ–≤</h2>
        <!-- historyContent —Ç–µ–ø–µ—Ä—å flex-grow: 1 –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫—É -->
        <div id="historyContent" class="space-y-3" style="height: calc(100% - 3.5rem);">
            <!-- History items here -->
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ -->
        <button onclick="toggleHistory()" class="absolute top-4 right-4 text-xl p-2 rounded-full hover:bg-gray-700 transition" style="color: var(--color-text-primary);">
            &times;
        </button>
    </div>

    <!-- 2. Main Content Area -->
    <main class="pt-20 pb-4 px-4 max-w-7xl mx-auto min-h-screen">
        
        <!-- Controls Panel: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç var(--color-bg-medium) -->
        <div class="control-panel p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-end transition-colors duration-300">
            <!-- 1. –í—ã–±–æ—Ä –¢–∏–ø–∞ –°—é–∂–µ—Ç–∞ -->
            <div class="flex-1 min-w-[180px]">
                <label for="storyTypeSelect" id="labelStoryType" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);">–¢–∏–ø —Å—é–∂–µ—Ç–∞</label>
                <!-- Select: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç var(--color-bg-main) -->
                <select id="storyTypeSelect" onchange="initializeOrUpdateUI(true)" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition" style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- 2. –í—ã–±–æ—Ä –ê—Ä–∫–∏ (–ù–û–í–´–ô –≠–õ–ï–ú–ï–ù–¢) -->
            <div id="arcSelectContainer" class="flex-1 min-w-[250px] hidden">
                <label for="arcSelect" id="labelArc" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);">–ê—Ä–∫–∞</label>
                <select id="arcSelect" onchange="updateChapterSelect(); saveProgress()" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition" disabled style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- 3. –í—ã–±–æ—Ä –ì–ª–∞–≤—ã -->
            <div class="flex-1 min-w-[250px]">
                <label for="chapterSelect" id="labelChapter" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);">–°—é–∂–µ—Ç (–ì–ª–∞–≤–∞)</label>
                <!-- Select: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç var(--color-bg-main) -->
                <select id="chapterSelect" onchange="enableLoadButton(); saveProgress()" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition" disabled style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <button id="loadButton" onclick="updateStoryContent(0)" class="min-w-[120px] load-button text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50" disabled>
                <span id="loadText">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
            </button>
        </div>

        <!-- 3. Visual Novel Viewer (Main View) -->
        <!-- –§–æ–Ω –≤—å—é–≤–µ—Ä–∞: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç var(--color-bg-main) -->
        <div id="vnViewer" class="relative w-full aspect-[16/9] rounded-xl shadow-2xl overflow-hidden flex flex-col justify-end transition-colors duration-500 cursor-pointer" 
             style="min-height: 400px; background-color: var(--color-bg-main);"
             onclick="navigateDialogue(1)"> 
            
            <!-- Background Layers Container (–¥–ª—è –∫—Ä–æ—Å—Å-—Ñ–µ–π–¥–∞) -->
            <div id="backgroundContainer" class="absolute inset-0 z-0">
                <div id="bgLayer1" class="absolute inset-0 bg-layer opacity-100"></div>
                <div id="bgLayer2" class="absolute inset-0 bg-layer opacity-0"></div>
            </div>

            <!-- Sprite Container: –ü—Ä–∏–≤—è–∑–∫–∞ bottom: 0 —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ -->
            <div id="spriteContainer" class="absolute inset-0 z-10 pointer-events-none flex justify-center items-end p-4">
                
                <div id="spriteLeftContainer" class="sprite-position left hidden">
                    <img id="spriteLeft" class="sprite-image" src="" alt="–õ–µ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" ondragstart="return false;">
                </div>
                
                <div id="spriteRightContainer" class="sprite-position right hidden">
                    <img id="spriteRight" class="sprite-image" src="" alt="–ü—Ä–∞–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" ondragstart="return false;">
                </div>
            </div>

            <!-- Dialogue Wrapper -->
            <div id="dialogueWrapper" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 transition-all duration-300 opacity-100 hidden">
                
                <!-- Speaker Name Container -->
                <div id="speakerNameContainer" class="text-left mb-0 ml-8"> 
                    <div id="currentSpeaker" class="speaker-name rounded-t-lg rounded-b-none"></div>
                </div>
                
                <!-- Dialogue Text Content Box -->
                <div id="dialogueContentBox" 
                    class="vn-overlay w-[900px] h-[200px] p-8 flex items-start justify-start text-left rounded-xl shadow-2xl overflow-hidden"> 
                    <p id="currentText" class="text-xl leading-tight transition-opacity duration-300">–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞...</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ====================================================================
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï ===
        // ====================================================================
        
        const CONFIG = {
            PATHS: {
                SPRITE_BASE: 'images/sprites/',
                BACKGROUND_BASE: 'images/background/',
                METADATA_FILE: 'story/story_metadata.json', 
                STORY_BASE: 'story/', 
            },
            STORAGE: {
                KEY: 'vn_story_progress_v6', // –û–±–Ω–æ–≤–ª–µ–Ω –∫–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                THEME_KEY: 'vn_theme',
            },
            BACKOFF: {
                INITIAL_DELAY_MS: 750,  
                MAX_DELAY_MS: 7500,     
                MAX_ATTEMPTS: 3,        
            },
            PLACEHOLDERS: {
                DEFAULT_BG_COLOR: '#1f2937', 
            }
        };

        const STORY_GROUPS = {
            main: { 
                ru: "–û—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç", 
                en: "Main Story", 
                zh: "‰∏ªÁ∫øÊïÖ‰∫ã", 
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞—Ä–æ–∫ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—é–∂–µ—Ç–∞ (–ü–†–ï–§–ò–ö–°–´ –û–ë–ù–û–í–õ–ï–ù–´)
                arcs: { 
                    retrospect: { ru: "–†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç—Ä", en: "Retrospect", zh: "ËøΩÊ∫ØÁØá", prefix: "re" },       // re
                    legacy: { ru: "–ù–∞—Å–ª–µ–¥–∏–µ", en: "Inheritance", zh: "‰º†ÊâøÁØá", prefix: "in" },           // in
                    moth: { ru: "–û–≥–Ω–µ–Ω–Ω—ã–π –ú–æ—Ç—ã–ª—ë–∫", en: "Fire Moth", zh: "ÈÄêÁÅ´‰πãËõæ", prefix: "fm" },  // fm
                    new_start: { ru: "–ù–æ–≤–æ–µ –Ω–∞—á–∞–ª–æ", en: "New Start", zh: "Êñ∞ÁîüÁØá", prefix: "nb" }, // nb
                    academy: { ru: "–ê–∫–∞–¥–µ–º–∏—è –•–æ—É–∫–∞—è", en: "Houkai Academy", zh: "Â¥©ÂùèÂ≠¶Âõ≠ÁØá", prefix: "ha" }, // ha
                }
            },
            extra: { ru: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—é–∂–µ—Ç", en: "Extra Story", zh: "È¢ùÂ§ñÊïÖ‰∫ã", prefix: "extra_" },
            bosses: { ru: "–ë–æ—Å—Å—ã", en: "Boss", zh: "Boss", prefix: "boss_" },
            vn: { ru: "–í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞", en: "Visual Novel", zh: "ËßÜËßâÂ∞èËØ¥", prefix: "vn_" },
            romance: { ru: "–†–æ–º–∞–Ω", en: "Romance", zh: "Êµ™Êº´", prefix: "ln_" }
        };
        
        let currentDialogue = []; 
        let currentDialogueIndex = 0;
        let dialogueIsLoaded = false;
        let currentBackgroundUrl = null; 
        window.storyMetadata = null; 
        let isHistoryVisible = false; 
        let activeBgLayer = 1; // 1 –∏–ª–∏ 2

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–ø—Ä–∞–π—Ç–æ–≤
        let currentLeftSpriteFile = null;
        let currentRightSpriteFile = null;
        
        // –ü–µ—Ä–µ–≤–æ–¥—ã UI
        const i18n = {
            ru: {
                headerTitle: "–ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞ Houkai Gakuen 2", labelStoryType: "–¢–∏–ø —Å—é–∂–µ—Ç–∞", labelArc: "–ê—Ä–∫–∞", labelChapter: "–°—é–∂–µ—Ç (–ì–ª–∞–≤–∞)",
                loadText: "–ó–∞–≥—Ä—É–∑–∏—Ç—å", resetProgress: "–°–±—Ä–æ—Å", endOfStory: "–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å!",
                startOfStory: "–≠—Ç–æ –Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏.", placeholderMetadata: "--- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ---",
                errorFetchMetadataStrict: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–ª–∞–≤. –§–∞–π–ª story/story_metadata.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
                errorChapterNotFound: "–§–∞–π–ª –≥–ª–∞–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                themeDark: "–¢—ë–º–Ω–∞—è", themeLight: "–°–≤–µ—Ç–ª–∞—è",
                historyTitle: "–ò—Å—Ç–æ—Ä–∏—è –î–∏–∞–ª–æ–≥–æ–≤", historyButton: "–ò—Å—Ç–æ—Ä–∏—è", historyEmpty: "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.",
                selectArcPlaceholder: "--- –í—ã–±–µ—Ä–∏—Ç–µ –∞—Ä–∫—É ---",
                selectChapterPlaceholder: "--- –í—ã–±–µ—Ä–∏—Ç–µ –≥–ª–∞–≤—É ---",
            },
            en: {
                headerTitle: "VN Story Archive", labelStoryType: "Story Type", labelArc: "Arc", labelChapter: "Chapter",
                loadText: "Load", resetProgress: "Reset", endOfStory: "Story finished!",
                startOfStory: "This is the start of the story.", placeholderMetadata: "--- Metadata not loaded ---",
                errorFetchMetadataStrict: "Critical Error: Failed to load chapter metadata. The file story/story_metadata.json is missing or inaccessible.",
                errorChapterNotFound: "Chapter file not found.",
                themeDark: "Dark", themeLight: "Light",
                historyTitle: "Dialogue History", historyButton: "History", historyEmpty: "History is empty.",
                selectArcPlaceholder: "--- Select Arc ---",
                selectChapterPlaceholder: "--- Select Chapter ---",
            },
            zh: {
                headerTitle: "ËßÜËßâÂ∞èËØ¥ÊïÖ‰∫ãÊ°£Ê°à", labelStoryType: "ÊïÖ‰∫ãÁ±ªÂûã", labelArc: "ÁØáÁ´†", labelChapter: "Á´†ËäÇ",
                loadText: "Âä†ËΩΩ", resetProgress: "ÈáçÁΩÆ", endOfStory: "ÊïÖ‰∫ãÁªìÊùü‰∫Ü!",
                startOfStory: "ËøôÊòØÊïÖ‰∫ãÁöÑÂºÄÂßã„ÄÇ", placeholderMetadata: "--- Êú™Âä†ËΩΩÂÖÉÊï∞ÊçÆ ---",
                errorFetchMetadataStrict: "Ëá¥ÂëΩÈîôËØØÔºöÊó†Ê≥ïÂä†ËΩΩÁ´†ËäÇÂÖÉÊï∞ÊçÆ„ÄÇÊñá‰ª∂ story/story_metadata.json Áº∫Â§±ÊàñÊó†Ê≥ïËÆøÈóÆ„ÄÇ",
                errorChapterNotFound: "Êú™ÊâæÂà∞Á´†ËäÇÊñá‰ª∂„ÄÇ",
                themeDark: "Ê∑±Ëâ≤", themeLight: "ÊµÖËâ≤",
                historyTitle: "ÂØπËØùÂéÜÂè≤", historyButton: "History", historyEmpty: "ÂéÜÂè≤‰∏∫Á©∫„ÄÇ",
                selectArcPlaceholder: "--- ÈÄâÊã©ÁØáÁ´† ---",
                selectChapterPlaceholder: "--- ÈÄâÊã©Á´†ËäÇ ---",
            }
        };

        // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        let elements = {};

        // ====================================================================
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–ê–ú–ò ===
        // ====================================================================

        function saveTheme(theme) {
            localStorage.setItem(CONFIG.STORAGE.THEME_KEY, theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const lang = elements.languageSelect.value;
            const isDark = theme === 'dark';
            
            document.body.classList.toggle('light-theme', !isDark);
            document.body.classList.toggle('dark-theme', isDark);

            if (elements.themeIcon && elements.themeText) {
                elements.themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                elements.themeText.textContent = isDark ? i18n[lang].themeDark : i18n[lang].themeLight;
            }
            
            // –ï—Å–ª–∏ —Ñ–æ–Ω —Å–µ–π—á–∞—Å —Ü–≤–µ—Ç–Ω–æ–π (–Ω–µ –∫–∞—Ä—Ç–∏–Ω–∫–∞), –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É—è –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            if (currentBackgroundUrl === CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR) {
                 // –ü–æ–ª—É—á–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –∏–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                 const themeBgColor = getComputedStyle(document.body).getPropertyValue('--color-bg-main').trim();
                 
                 const activeLayer = activeBgLayer === 1 ? elements.bgLayer1 : elements.bgLayer2;
                 const inactiveLayer = activeBgLayer === 1 ? elements.bgLayer2 : elements.bgLayer1;

                 activeLayer.style.backgroundColor = themeBgColor;
                 inactiveLayer.style.backgroundColor = themeBgColor;
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            saveTheme(newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(CONFIG.STORAGE.THEME_KEY) || 'dark';
            applyTheme(savedTheme);
        }

        // ====================================================================
        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
            elements.languageSelect = document.getElementById('languageSelect');
            elements.storyTypeSelect = document.getElementById('storyTypeSelect');
            
            // –ù–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ê—Ä–∫–∏
            elements.arcSelectContainer = document.getElementById('arcSelectContainer');
            elements.arcSelect = document.getElementById('arcSelect');
            
            elements.chapterSelect = document.getElementById('chapterSelect');
            elements.loadButton = document.getElementById('loadButton');
            elements.loadText = document.getElementById('loadText');
            elements.vnViewerElement = document.getElementById('vnViewer');
            elements.dialogueWrapper = document.getElementById('dialogueWrapper');
            elements.spriteLeftContainer = document.getElementById('spriteLeftContainer');
            elements.spriteRightContainer = document.getElementById('spriteRightContainer');
            elements.spriteLeftElement = document.getElementById('spriteLeft');
            elements.spriteRightElement = document.getElementById('spriteRight');
            elements.currentSpeaker = document.getElementById('currentSpeaker');
            elements.currentText = document.getElementById('currentText');
            elements.speakerNameContainer = document.getElementById('speakerNameContainer');
            elements.bgLayer1 = document.getElementById('bgLayer1');
            elements.bgLayer2 = document.getElementById('bgLayer2');
            elements.themeIcon = document.getElementById('themeIcon');
            elements.themeText = document.getElementById('themeText');
            
            // –≠–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏
            elements.historyPanel = document.getElementById('historyPanel');
            elements.historyContent = document.getElementById('historyContent');
            elements.historyTitle = document.getElementById('historyTitle');
            elements.historyButton = document.getElementById('historyToggle');
            elements.historyText = document.getElementById('historyText');


            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª–æ–π (—Ü–≤–µ—Ç)
            elements.bgLayer1.style.backgroundColor = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR;
            elements.bgLayer1.style.backgroundImage = 'none';
            currentBackgroundUrl = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR; 
            
            loadTheme(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ç–µ–º—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            loadProgress(); 
        });

        // ====================================================================
        // === CORE FUNCTIONS ===
        // ====================================================================
        
        /** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–ª–∞–≤. */
        async function fetchChapterMetadata() {
            try {
                const response = await fetch(CONFIG.PATHS.METADATA_FILE); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                window.storyMetadata = await response.json();
            } catch (error) {
                console.error(`[Metadata] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞.`, error);
                alertMessage(i18n[elements.languageSelect.value].errorFetchMetadataStrict); 
                window.storyMetadata = null; 
            }
        }

        /** –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —à–∞–≥—É –¥–∏–∞–ª–æ–≥–∞. */
        function navigateDialogue(direction) {
            if (!dialogueIsLoaded || currentDialogue.length === 0) return;
            
            const newIndex = currentDialogueIndex + direction;
            const lang = elements.languageSelect.value;

            if (newIndex >= 0 && newIndex < currentDialogue.length) {
                currentDialogueIndex = newIndex;
                renderDialogueStep();
                saveProgress();
            } else if (newIndex >= currentDialogue.length) {
                alertMessage(i18n[lang].endOfStory);
                currentDialogueIndex = currentDialogue.length - 1;
                saveProgress();
            } else {
                alertMessage(i18n[lang].startOfStory);
            }
        }
        
        /** –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å/URL –∫ —Å–ø—Ä–∞–π—Ç—É. */
        const spritePath = (fileName) => {
            if (!fileName) return null;
            const encodedFileName = encodeURIComponent(fileName);
            return CONFIG.PATHS.SPRITE_BASE + encodedFileName; 
        };
        
        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø—Ä–∞–π—Ç–∞ –∏ –ø–ª–∞–≤–Ω–æ –µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ –≤ —Å—Ü–µ–Ω–µ.
         */
        function loadSprite(url, element, container) {
            
            if (!url) {
                // –ï—Å–ª–∏ URL –ø—É—Å—Ç, —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø—Ä–∞–π—Ç –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ —Å—Ü–µ–Ω—ã
                container.classList.add('hidden');
                element.src = '';
                return;
            }
            
            const tempImg = new Image();
            
            tempImg.onload = () => {
                element.src = tempImg.src; 
                container.classList.remove('hidden'); 
            };
            
            tempImg.onerror = () => {
                container.classList.add('hidden');
                console.warn(`[Sprite Load] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–π—Ç: ${url}.`);
                element.src = '';
            };

            const finalUrl = `${url}?t=${Date.now()}`;
            tempImg.src = finalUrl;
        }

        /** * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ñ–æ–Ω, –∏—Å–ø–æ–ª—å–∑—É—è —Ç–µ—Ö–Ω–∏–∫—É –∫—Ä–æ—Å—Å-—Ñ–µ–π–¥–∞. */
        function crossFadeBackground(newBgFileName) {
            const encodedBgFileName = encodeURIComponent(newBgFileName);
            const finalBgUrl = CONFIG.PATHS.BACKGROUND_BASE + encodedBgFileName;
            
            if (finalBgUrl === currentBackgroundUrl) return; 

            const { bgLayer1, bgLayer2 } = elements;
            const nextLayer = activeBgLayer === 1 ? bgLayer2 : bgLayer1;
            const currentLayer = activeBgLayer === 1 ? bgLayer1 : bgLayer2;
            
            const tempImg = new Image();
            
            tempImg.onload = () => {
                nextLayer.style.backgroundImage = `url('${tempImg.src}')`;
                nextLayer.style.backgroundColor = 'transparent'; 
                
                setTimeout(() => {
                    currentLayer.style.opacity = '0';
                    nextLayer.style.opacity = '1';
                    
                    activeBgLayer = activeBgLayer === 1 ? 2 : 1;
                    currentBackgroundUrl = tempImg.src;
                }, 10);
            };
            
            tempImg.onerror = () => {
                console.warn(`[BG Fade] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω: ${finalBgUrl}. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞.`);
                
                 setTimeout(() => {
                    nextLayer.style.backgroundImage = 'none';
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞
                    const themeBgColor = getComputedStyle(document.body).getPropertyValue('--color-bg-main').trim();

                    nextLayer.style.backgroundColor = themeBgColor;

                    currentLayer.style.opacity = '0';
                    nextLayer.style.opacity = '1';

                    activeBgLayer = activeBgLayer === 1 ? 2 : 1;
                    currentBackgroundUrl = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR;
                }, 10);
            };

            const finalUrl = `${finalBgUrl}?t=${Date.now()}`;
            tempImg.src = finalUrl;
        }


        /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Ç–µ–∫—É—â–∏–π —à–∞–≥ –¥–∏–∞–ª–æ–≥–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç UI. */
        function renderDialogueStep() {
            const { dialogueWrapper, spriteLeftContainer, spriteRightContainer, 
                    spriteLeftElement, spriteRightElement, currentSpeaker, currentText, speakerNameContainer } = elements;

            if (!dialogueIsLoaded || currentDialogue.length === 0) {
                dialogueWrapper.classList.add('hidden');
                return;
            }

            const step = currentDialogue[currentDialogueIndex];
            
            // 1. –§–æ–Ω
            if (step.background) { 
                crossFadeBackground(step.background);
            }

            // 2. –°–ø—Ä–∞–π—Ç—ã –∏ –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
            
            const speakingSpriteFile = step.sprite; 
            const activeSpeakerPosition = step.position ? step.position.toLowerCase() : null;

            // –°–±—Ä–æ—Å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
            spriteLeftElement.classList.remove('dimmed-sprite');
            spriteRightElement.classList.remove('dimmed-sprite');


            // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–π—Ç–∞ –ì–û–í–û–†–Ø–©–ï–ì–û –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ---
            if (speakingSpriteFile && activeSpeakerPosition) {
                const isLeftSpeaker = activeSpeakerPosition === 'left';
                
                const speakerElement = isLeftSpeaker ? spriteLeftElement : spriteRightElement;
                const speakerContainer = isLeftSpeaker ? spriteLeftContainer : spriteRightContainer;
                
                const dimmedElement = isLeftSpeaker ? spriteRightElement : spriteLeftElement;
                const dimmedContainer = isLeftSpeaker ? spriteRightContainer : spriteLeftContainer;

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–æ–≤—ã–π —Å–ø—Ä–∞–π—Ç
                let needsLoad = false;
                if (isLeftSpeaker && currentLeftSpriteFile !== speakingSpriteFile) {
                    needsLoad = true;
                    currentLeftSpriteFile = speakingSpriteFile;
                } else if (!isLeftSpeaker && currentRightSpriteFile !== speakingSpriteFile) {
                    needsLoad = true;
                    currentRightSpriteFile = speakingSpriteFile;
                }

                if (needsLoad) {
                    loadSprite(spritePath(speakingSpriteFile), speakerElement, speakerContainer);
                } else {
                    // –°–ø—Ä–∞–π—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –ø—Ä–æ—Å—Ç–æ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–Ω –≤–∏–¥–µ–Ω
                    speakerContainer.classList.remove('hidden');
                }

                // --- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –Ω–µ –≥–æ–≤–æ—Ä—è—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ---
                // –ó–∞—Ç–µ–º–Ω—è–µ–º –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–π —Å–ø—Ä–∞–π—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è (–Ω–µ hidden)
                if (!dimmedContainer.classList.contains('hidden')) {
                    dimmedElement.classList.add('dimmed-sprite');
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≥–æ–≤–æ—Ä—è—â–∏–π –Ω–µ –∑–∞—Ç–µ–º–Ω–µ–Ω (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞—Ç–µ–º–Ω–µ–Ω –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ)
                speakerElement.classList.remove('dimmed-sprite');

            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø—Ä–∞–π—Ç–∞ –≤ —ç—Ç–æ–º —à–∞–≥–µ, —ç—Ç–æ —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Ü–µ–Ω–∞
                // –í—Å–µ –≤–∏–¥–∏–º—ã–µ —Å–ø—Ä–∞–π—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å UNDIMMED
                if (!spriteLeftContainer.classList.contains('hidden')) {
                    spriteLeftElement.classList.remove('dimmed-sprite');
                }
                if (!spriteRightContainer.classList.contains('hidden')) {
                    spriteRightElement.classList.remove('dimmed-sprite');
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∏ —Å–ø—Ä–∞–π—Ç–∞, —Å–∫—Ä—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
                if (!step.text) {
                     dialogueWrapper.classList.add('hidden');
                     return;
                }
            }


            // 3. –¢–µ–∫—Å—Ç –∏ –ò–º—è –°–ø–∏–∫–µ—Ä–∞
            dialogueWrapper.classList.remove('hidden');
            
            if (step.speaker) {
                currentSpeaker.textContent = step.speaker;
                speakerNameContainer.classList.remove('hidden');
            } else {
                currentSpeaker.textContent = "";
                speakerNameContainer.classList.add('hidden');
            }
            
            currentText.textContent = step.text || "";
            
            // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ò—Å—Ç–æ—Ä–∏–∏
            if (isHistoryVisible) {
                // –ï—Å–ª–∏ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–∫—Ä—ã—Ç–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ, —á—Ç–æ–±—ã –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —à–∞–≥
                renderHistory();
            }
        }
        
        /** –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥–ª–∞–≤—É, –∏—Å–ø–æ–ª—å–∑—É—è Exponential Backoff. */
        async function updateStoryContent(startIndex = 0) {
            const lang = elements.languageSelect.value; 
            // fullStoryKey —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, "re_main_ch1"
            const fullStoryKey = elements.chapterSelect.value.trim(); 
            const { loadButton, loadText } = elements;
            
            if (!fullStoryKey) return;

            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª–Ω—ã–π –∫–ª—é—á
            const expectedFilePath = `${CONFIG.PATHS.STORY_BASE}${lang}/${fullStoryKey}.json`;
            const { INITIAL_DELAY_MS, MAX_DELAY_MS, MAX_ATTEMPTS } = CONFIG.BACKOFF;

            console.log(`[Content Load] –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–∞–≤—É: ${expectedFilePath}`);

            loadButton.disabled = true;
            loadText.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            
            const attemptLoad = async (attempt = 1) => {
                let success = false;
                let data = null;
                let errorType = null;

                try {
                    const cacheBuster = `?t=${Date.now()}_${attempt}`;
                    const response = await fetch(expectedFilePath + cacheBuster);
                    
                    if (response.status === 404) {
                        errorType = "404 Not Found";
                        throw new Error("404 Not Found");
                    }
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    data = await response.json();
                    success = true;
                } catch (e) {
                    if (e instanceof SyntaxError) {
                        errorType = "SyntaxError";
                        console.error(`[Content Load] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ JSON –≤ —Ñ–∞–π–ª–µ ${expectedFilePath}:`, e);
                    } else if (e.message !== "404 Not Found") {
                       console.error(`[Content Load] –û–±—â–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ü–æ–ø—ã—Ç–∫–∞ ${attempt}).`, e);
                    }
                }

                if (success && data) {
                    // --- –£–°–ü–ï–•: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
                    currentDialogue = data.dialogue || [];
                    currentDialogueIndex = Math.min(startIndex, currentDialogue.length - 1);
                    currentDialogueIndex = Math.max(0, currentDialogueIndex); 
                    dialogueIsLoaded = true;
                    currentBackgroundUrl = null; 
                    
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –Ø–í–ù–´–ô –°–ë–†–û–° –°–û–°–¢–û–Ø–ù–ò–Ø –°–ü–†–ê–ô–¢–û–í –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π –≥–ª–∞–≤—ã
                    currentLeftSpriteFile = null;
                    currentRightSpriteFile = null;
                    elements.spriteLeftContainer.classList.add('hidden');
                    elements.spriteRightContainer.classList.add('hidden');
                    elements.spriteLeftElement.src = ''; 
                    elements.spriteRightElement.src = '';
                    
                    loadText.textContent = "–ó–∞–≥—Ä—É–∂–µ–Ω–æ";
                    renderDialogueStep();

                    setTimeout(() => {
                        loadText.textContent = i18n[lang].loadText;
                        loadButton.disabled = false;
                    }, 1500);

                } else {
                    // --- –ü–û–í–¢–û–†–ù–ê–Ø –ü–û–ü–´–¢–ö–ê ---
                    if (errorType === "SyntaxError") {
                        loadText.textContent = "–û—à–∏–±–∫–∞ JSON";
                        alertMessage("–û—à–∏–±–∫–∞: –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ JSON-—Ñ–∞–π–ª–µ –≥–ª–∞–≤—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                        loadButton.disabled = false;
                        return;
                    }
                    
                    if (attempt >= MAX_ATTEMPTS) {
                        loadText.textContent = i18n[lang].errorChapterNotFound;
                        loadButton.disabled = false;
                        console.error(`[Content Load] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–ª–∞–≤—É "${fullStoryKey}" –ø–æ—Å–ª–µ ${MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫.`);
                        return;
                    }
                    
                    const delay = Math.min(MAX_DELAY_MS, INITIAL_DELAY_MS * Math.pow(2, attempt - 1));
                    loadText.textContent = `–ü–æ–≤—Ç–æ—Ä (${attempt})...`;

                    setTimeout(() => attemptLoad(attempt + 1), delay);
                }
            };
            
            attemptLoad();
        }

        // ====================================================================
        // === UI & I18N FUNCTIONS ===
        // ====================================================================

        /** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞. */
        function alertMessage(message) {
            const header = document.getElementById('header');
            const msgBox = document.createElement('div');
            msgBox.textContent = message;
            msgBox.className = 'fixed top-1 right-1/2 translate-x-1/2 p-2 text-white rounded-lg shadow-xl z-50 text-sm transition-opacity duration-300 alert-message';
            header.appendChild(msgBox);
            
            setTimeout(() => {
                msgBox.style.opacity = '0';
                setTimeout(() => msgBox.remove(), 300);
            }, 5000);
        }

        function updateI18nStrings() {
            const lang = elements.languageSelect.value;
            const text = i18n[lang] || i18n.ru; // Fallback to Russian
            
            document.getElementById('headerTitle').textContent = text.headerTitle;
            document.getElementById('labelStoryType').textContent = text.labelStoryType;
            document.getElementById('labelArc').textContent = text.labelArc; 
            document.getElementById('labelChapter').textContent = text.labelChapter;
            elements.loadText.textContent = text.loadText;
            document.getElementById('resetButton').textContent = text.resetProgress;
            elements.historyText.textContent = text.historyButton;
            elements.historyTitle.textContent = text.historyTitle;

            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –∫–Ω–æ–ø–∫–µ —Ç–µ–º—ã
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            elements.themeText.textContent = currentTheme === 'dark' ? text.themeDark : text.themeLight;

            const typeSelect = elements.storyTypeSelect;
            const savedType = typeSelect.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ
            typeSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "---";
            typeSelect.appendChild(defaultOption);

            for (const key in STORY_GROUPS) {
                const option = document.createElement('option');
                const groupData = STORY_GROUPS[key];
                option.value = key;
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —è–∑—ã–∫–∞, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ fallback –Ω–∞ RU
                option.textContent = groupData[lang] || groupData.ru; 
                typeSelect.appendChild(option);
            }
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
            typeSelect.value = savedType || '';
        }
        
        /** * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∞—Ä–æ–∫ –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤–∏–¥–∏–º–æ—Å—Ç—å—é. */
        function updateArcSelect() {
            const typeKey = elements.storyTypeSelect.value;
            const { arcSelect, arcSelectContainer } = elements;
            const lang = elements.languageSelect.value;
            const currentArcKey = arcSelect.value; 

            arcSelect.innerHTML = '';
            arcSelect.disabled = true;
            
            const isMainStory = (typeKey === 'main');
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∞—Ä–∫–∏ (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "main")
            elements.arcSelectContainer.classList.toggle('hidden', !isMainStory);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ù–ï –æ—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º
            if (!isMainStory) {
                // –ï—Å–ª–∏ –º—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—é–∂–µ—Ç–∞, —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ arcSelect —Å–±—Ä–æ—à–µ–Ω
                arcSelect.value = '';
                updateChapterSelect(); 
                return;
            }

            // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –û—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—é–∂–µ—Ç–∞ (isMainStory === true) ---

            const arcs = STORY_GROUPS.main.arcs;
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = i18n[lang].selectArcPlaceholder;
            defaultOption.disabled = true;
            defaultOption.selected = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            arcSelect.appendChild(defaultOption);

            let arcFound = false;

            for (const key in arcs) {
                const arcData = arcs[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = arcData[lang] || arcData.ru; 
                
                // –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ select.value —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–æ–º –∞—Ä–∫–∏, –≤—ã–±–∏—Ä–∞–µ–º –µ–≥–æ
                if (key === currentArcKey) {
                    option.selected = true;
                    arcFound = true;
                }
                arcSelect.appendChild(option);
            }
            
            // –í–∫–ª—é—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∞ –∞—Ä–∫–∏
            if (Object.keys(arcs).length > 0) {
                 arcSelect.disabled = false;
                 // –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–∏–ª–∏ –Ω–µ –±—ã–ª–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ), —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–≥–ª—É—à–∫–∞
                 if (!arcFound) arcSelect.value = ''; 
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤ (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –∏–ª–∏ —Å–±—Ä–æ—à–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ arcSelect.value)
            updateChapterSelect();
        }


        /** –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤. */
        function updateChapterSelect(skipSideEffects = false) {
            const typeKey = elements.storyTypeSelect.value;
            const arcKey = elements.arcSelect.value; // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ typeKey === 'main'
            const select = elements.chapterSelect;
            const lang = elements.languageSelect.value;
            const currentChapterKey = select.value; // –¢–µ–ø–µ—Ä—å —ç—Ç–æ "re_main_ch1", "extra_1", –∏ —Ç.–¥.

            select.innerHTML = '';
            select.disabled = true; 
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";

            if (!window.storyMetadata) {
                defaultOption.textContent = i18n[lang].placeholderMetadata;
                select.appendChild(defaultOption);
                if (!skipSideEffects) enableLoadButton();
                return;
            }
            
            defaultOption.textContent = i18n[lang].selectChapterPlaceholder;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);
            
            let prefix = null;
            let chapterFound = false;
            let chaptersCount = 0; // –°—á–µ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

            console.log(`[UpdateChapters] –ó–∞–ø—É—Å–∫. –¢–∏–ø: ${typeKey}, –ê—Ä–∫–∞: ${arcKey || '–ù–µ –≤—ã–±—Ä–∞–Ω–∞'}. –¢–µ–∫—É—â–∏–π –∫–ª—é—á: ${currentChapterKey}`);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            if (typeKey === 'main' && arcKey) {
                // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –û–°–ù–û–í–ù–û–ì–û –°–Æ–ñ–ï–¢–ê: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ ---
                const arcData = STORY_GROUPS.main.arcs[arcKey];
                prefix = arcData ? arcData.prefix : null;

                if (prefix) {
                    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –∫–ª—é—á–∏ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–º–µ—é—Ç —Ñ–æ—Ä–º–∞—Ç 're_1', 're_2' –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞
                    for (const metaKey in window.storyMetadata) {
                        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º, –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∞—Ä–∫–∏
                        if (metaKey.startsWith(prefix + '_')) { 
                            const chapterData = window.storyMetadata[metaKey];
                            
                            // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –≥–ª–∞–≤—ã (—Ç–æ, —á—Ç–æ –∏–¥–µ—Ç –ø–æ—Å–ª–µ –ø—Ä–µ—Ñ–∏–∫—Å–∞ –∏ _)
                            const chapterNumber = metaKey.substring(prefix.length + 1); 
                            
                            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º
                            // –ù–∞–ø—Ä–∏–º–µ—Ä: "re_main_ch1"
                            const newFullChapterKey = `${prefix}_main_ch${chapterNumber}`; 

                            const chapterName = chapterData[lang] || chapterData.ru; 
                            
                            if (chapterName) {
                                chaptersCount++;
                                const option = document.createElement('option');
                                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ –∫–∞–∫ value
                                option.value = newFullChapterKey; 
                                option.textContent = chapterName; 
                                
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–ª—é—á –ø–æ –Ω–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
                                if (newFullChapterKey === currentChapterKey) {
                                     option.selected = true;
                                     chapterFound = true; 
                                }
                                select.appendChild(option);
                            }
                        }
                    }
                    console.log(`[UpdateChapters] –ù–∞–π–¥–µ–Ω–æ –≥–ª–∞–≤ –¥–ª—è –û—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—é–∂–µ—Ç–∞ (${arcKey}, –ø—Ä–µ—Ñ–∏–∫—Å: ${prefix}): ${chaptersCount}`);
                } else {
                     console.warn(`[UpdateChapters] –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∞—Ä–∫–∏ "${arcKey}".`);
                }
                
            } else if (typeKey !== 'main' && STORY_GROUPS[typeKey]) {
                // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –î–†–£–ì–ò–• –°–Æ–ñ–ï–¢–û–í: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (prefix_number) ---
                prefix = STORY_GROUPS[typeKey].prefix;

                for (const fullChapterKey in window.storyMetadata) {
                    if (fullChapterKey.startsWith(prefix)) { 
                        const chapterData = window.storyMetadata[fullChapterKey];
                        const chapterName = chapterData[lang] || chapterData.ru; 
                        
                        if (chapterName) {
                            chaptersCount++;
                            const option = document.createElement('option');
                            option.value = fullChapterKey; 
                            option.textContent = chapterName; 
                            
                            if (fullChapterKey === currentChapterKey) {
                                 option.selected = true;
                                 chapterFound = true; 
                            }
                            select.appendChild(option);
                        }
                    }
                }
                 console.log(`[UpdateChapters] –ù–∞–π–¥–µ–Ω–æ –≥–ª–∞–≤ –¥–ª—è —Ç–∏–ø–∞ '${typeKey}': ${chaptersCount}`);
            }
            
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "main", –Ω–æ –∞—Ä–∫–∞ –ù–ï –≤—ã–±—Ä–∞–Ω–∞, —Ç–æ –≥–ª–∞–≤—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
            if (typeKey === 'main' && !arcKey) {
                console.log(`[UpdateChapters] –û—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç –≤—ã–±—Ä–∞–Ω, –Ω–æ –ê—Ä–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–ª–∞–≤.`);
                select.disabled = true;
                select.value = '';
                if (!skipSideEffects) enableLoadButton();
                return;
            }

            if (select.options.length > 1) { // > 1, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ—Å—Ç—å –∑–∞–≥–ª—É—à–∫–∞
                 select.disabled = false;
            }
            
            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –≥–ª–∞–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –Ω–æ–≤–æ–º —Å–ø–∏—Å–∫–µ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            if (!chapterFound) select.value = '';
            
            
            if (!skipSideEffects) {
                enableLoadButton();
                saveProgress(); 
            }
        }

        function enableLoadButton() {
            const storyId = elements.chapterSelect.value;
            elements.loadButton.disabled = !storyId;
        }
        
        // –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ –∏–ª–∏ —Ç–∏–ø–∞ —Å—é–∂–µ—Ç–∞
        function initializeOrUpdateUI(calledByUIEvent) {
            updateI18nStrings(); // –û–±–Ω–æ–≤–ª—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è UI –∏ –æ–ø—Ü–∏–∏ storyTypeSelect
            updateArcSelect(); // –û–±–Ω–æ–≤–ª—è–µ—Ç –æ–ø—Ü–∏–∏ arcSelect –∏ –≤—ã–∑—ã–≤–∞–µ—Ç updateChapterSelect()
            
            if (calledByUIEvent) {
                 saveProgress(); 
            }
        }

        // ====================================================================
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ï–ô ===
        // ====================================================================

        function toggleHistory() {
            isHistoryVisible = !isHistoryVisible;
            elements.historyPanel.classList.toggle('open', isHistoryVisible);
            
            if (isHistoryVisible) {
                setTimeout(renderHistory, 300); 
            }
        }

        function renderHistory() {
            const { historyContent } = elements;
            const lang = elements.languageSelect.value;
            historyContent.innerHTML = '';
            
            if (!dialogueIsLoaded || currentDialogue.length === 0) {
                historyContent.innerHTML = `<p class="text-center mt-8 p-3 rounded-lg" style="color: var(--color-text-secondary); background-color: var(--color-bg-medium);">${i18n[lang].historyEmpty}</p>`;
                return;
            }
            
            const fragment = document.createDocumentFragment();

            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —à–∞–≥–∏ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
            for (let i = 0; i <= currentDialogueIndex; i++) {
                const step = currentDialogue[i];
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —à–∞–≥–∏ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —á–∏—Å—Ç–∞—è —Å–º–µ–Ω–∞ —Ñ–æ–Ω–∞ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ
                if (!step.text && i !== 0) continue; 
                
                const isCurrent = (i === currentDialogueIndex);

                const historyItem = document.createElement('div');
                
                historyItem.className = `p-3 rounded-lg cursor-pointer transition duration-150 shadow-md border border-transparent`;
                
                // –°—Ç–∏–ª—å –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ (—Ç–µ–∫—É—â–µ–≥–æ) —ç–ª–µ–º–µ–Ω—Ç–∞
                if (isCurrent) {
                    historyItem.classList.add('ring-2', 'ring-offset-2');
                    historyItem.style.backgroundColor = 'var(--color-accent-primary)'; 
                    historyItem.style.color = 'white';
                    historyItem.style.borderColor = 'var(--color-accent-ring)';
                    historyItem.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
                    historyItem.style.fontWeight = 'bold';
                } else {
                    // –°—Ç–∏–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    historyItem.style.backgroundColor = 'var(--color-bg-medium)'; 
                    historyItem.style.color = 'var(--color-text-primary)';
                }
                
                // –ö–ª–∏–∫ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —à–∞–≥—É
                historyItem.dataset.index = i; 
                historyItem.onclick = () => {
                    currentDialogueIndex = i;
                    renderDialogueStep();
                    saveProgress();
                    toggleHistory(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞
                };

                if (step.speaker) {
                    const speakerName = document.createElement('p');
                    speakerName.className = 'font-bold mb-1';
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç —Å–ø–∏–∫–µ—Ä–∞, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—É—â–∏–π —à–∞–≥
                    speakerName.style.color = isCurrent ? 'white' : 'var(--color-speaker-name)'; 
                    speakerName.textContent = step.speaker;
                    historyItem.appendChild(speakerName);
                }

                const textContent = document.createElement('p');
                textContent.className = 'text-sm leading-snug';
                textContent.textContent = step.text || `[${step.background ? '–°—Ü–µ–Ω–∞: ' + step.background : '–≠–ª–µ–º–µ–Ω—Ç –°—é–∂–µ—Ç–∞'}]`;
                historyItem.appendChild(textContent);

                fragment.appendChild(historyItem);
            }
            
            historyContent.appendChild(fragment);
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –¥–∏–∞–ª–æ–≥–æ–≤–æ–º—É —à–∞–≥—É
            const currentItem = historyContent.querySelector(`[data-index="${currentDialogueIndex}"]`);
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ====================================================================
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°–û–ú ===
        // ====================================================================
        
        function saveProgress() {
            const progress = {
                lang: elements.languageSelect.value,
                type: elements.storyTypeSelect.value,
                arc: elements.arcSelect.value, 
                chapter: elements.chapterSelect.value, 
                index: currentDialogueIndex,
            };
            localStorage.setItem(CONFIG.STORAGE.KEY, JSON.stringify(progress));
        }

        async function loadProgress() {
            await fetchChapterMetadata(); 
            
            const savedProgress = localStorage.getItem(CONFIG.STORAGE.KEY);
            let progress = {};

            if (savedProgress) {
                try {
                    progress = JSON.parse(savedProgress);
                } catch(e) {
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å.", e);
                    localStorage.removeItem(CONFIG.STORAGE.KEY);
                }
            }
            
            const { languageSelect, storyTypeSelect, arcSelect, chapterSelect } = elements;
            
            // 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫
            languageSelect.value = progress.lang && i18n[progress.lang] ? progress.lang : 'ru';
            updateI18nStrings(); 
            
            // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤ —Å–µ–ª–µ–∫—Ç—ã (–±–µ–∑ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ onchange)
            storyTypeSelect.value = progress.type && STORY_GROUPS[progress.type] ? progress.type : '';
            arcSelect.value = progress.arc || '';
            // chapterSelect.value —Ç–µ–ø–µ—Ä—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –Ω–æ–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–µ "re_main_ch1"
            chapterSelect.value = progress.chapter || '';


            // 3. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ UI –æ–ø—Ü–∏—è–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            updateArcSelect(); // –ó–∞–ø–æ–ª–Ω—è–µ—Ç –æ–ø—Ü–∏–∏ –ê—Ä–∫–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç updateChapterSelect()
            
            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ –≥–ª–∞–≤–∞ –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –Ω–∞–π–¥–µ–Ω–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
            // –î–ª—è Main Story –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å—Å—è –ø–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º—É –∫–ª—é—á—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, 're_1')
            // –î–ª—è Other Stories –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –∫–ª—é—á ('extra_1', –∏ —Ç.–¥.)
            
            const currentChapterValue = chapterSelect.value;
            let chapterExists = false;

            if (currentChapterValue) {
                if (storyTypeSelect.value === 'main') {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –Ω–æ–º–µ—Ä –∏–∑ "re_main_ch1" -> "re", "1"
                    const match = currentChapterValue.match(/^(\w+)_main_ch(\d+)$/);
                    if (match && window.storyMetadata) {
                         // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ 're_1'
                         const metaKey = `${match[1]}_${match[2]}`;
                         chapterExists = !!window.storyMetadata[metaKey];
                    }
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –∫–ª—é—á
                    chapterExists = window.storyMetadata && !!window.storyMetadata[currentChapterValue];
                }
            }

            if (currentChapterValue && chapterExists) {
                 updateStoryContent(progress.index); 
            } else {
                 enableLoadButton();
            }
        }

        function resetProgress() {
            localStorage.removeItem(CONFIG.STORAGE.KEY);
            dialogueIsLoaded = false;
            currentDialogueIndex = 0;
            currentDialogue = []; 
            currentBackgroundUrl = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR; 
            activeBgLayer = 1;
            isHistoryVisible = false;
            elements.historyPanel.classList.remove('open'); 

            
            // –Ø–≤–Ω—ã–π —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            currentLeftSpriteFile = null;
            currentRightSpriteFile = null;

            elements.dialogueWrapper.classList.add('hidden');
            elements.languageSelect.value = 'ru';
            
            // –û—á–∏—Å—Ç–∫–∞ –∏ —Å–∫—Ä—ã—Ç–∏–µ —Å–ø—Ä–∞–π—Ç–æ–≤
            elements.spriteLeftContainer.classList.add('hidden');
            elements.spriteRightContainer.classList.add('hidden');
            elements.spriteLeftElement.src = ''; 
            elements.spriteRightElement.src = '';

            // –°–±—Ä–æ—Å —Ñ–æ–Ω–∞ –Ω–∞ —Ü–≤–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Ç–µ–∫—É—â–µ–π —Ç–µ–º–µ
            const themeBgColor = getComputedStyle(document.body).getPropertyValue('--color-bg-main').trim();

            elements.bgLayer1.style.backgroundImage = 'none';
            elements.bgLayer1.style.backgroundColor = themeBgColor;
            elements.bgLayer1.style.opacity = '1';
            elements.bgLayer2.style.opacity = '0';
            
            loadProgress(); // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            
            alertMessage("–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω!");
        }
    </script>
</body>
</html>
