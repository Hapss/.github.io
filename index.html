<!-- Chosen Palette: Dark Neutrals (Black, Grey, White) with Honkai Red/Purple accents for UI elements. -->
<!-- Application Structure Plan: Single-page application with a fixed header for navigation (language selector, title, reset button) and a main content area. The main area is divided into a control panel (story type/chapter selection) and a large, immersive Visual Novel (VN) viewer. This dashboard-like structure prioritizes interactivity (filters/selectors) and contextual presentation (VN viewer with dynamic text/sprites/backgrounds and LLM tools). This structure was chosen for usability because it separates navigation from the viewing experience, making it easy to change the story without losing immersion. Progress persistence is added via localStorage. -->
<!-- Visualization & Content Choices: Report Info -> Goal -> Viz/Presentation Method -> Interaction -> Justification -> Library/Method.
1. Story Content -> Narrative Consumption -> Visual Novel Display (HTML/CSS, Dynamic text/images) -> Next/Prev buttons, Dropdowns, Persistence (localStorage) -> Best way to present dialogue-heavy game lore, now with user progress tracking. -> Vanilla JS/HTML/CSS.
2. Character/Scene Analysis -> Contextual Understanding -> Text Output (Modal window) -> Clickable buttons (Character Info/Scene Analysis) -> Enhances comprehension by leveraging LLM expertise instantly. -> Gemini API (Fetch/JSON).
3. Navigation/Filtering -> Content Discovery -> Dropdown Menus (Type and Chapter) -> Cascading selection (Type filters Chapter options) -> Efficiently handles large, hierarchical data sets (story chapters). -> Vanilla JS/HTML/CSS.
4. Progress Persistence -> User Experience -> localStorage save/load/reset functions -> Automatically resumes reading where the user left off. -> Vanilla JS.
-->
<!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Houkai Gakuen 2 Архив Сюжета</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #5c5c5c; /* Фон сайта */
            color: #e5e7eb;
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .vn-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            max-width: 95%;
            margin: 0 auto;
        }
        .speaker-name {
            background-color: #2a2a2a;
            color: #fca5a5; /* Мягкий красный акцент */
            padding: 4px 12px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: inline-block;
            margin-bottom: -1px;
            font-weight: bold;
        }
        .sprite {
            position: absolute;
            bottom: 0;
            max-height: 85%; /* Ограничение высоты спрайта */
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10;
        }
        .sprite.left {
            left: 20px;
        }
        .sprite.right {
            right: 20px;
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter, .fade-leave-to /* .fade-leave-active in <2.1.8 */ {
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- 1. Header Bar -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 p-4 shadow-xl text-white" style="background-color: #2a2a2a;">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <h1 id="headerTitle" class="text-xl font-bold tracking-wider">Houkai Gakuen 2 архив сюжета</h1>
            
            <div class="flex items-center space-x-4">
                <button id="resetButton" onclick="resetProgress()" class="px-3 py-1 bg-red-800 hover:bg-red-700 rounded-full transition duration-150 text-sm">Сброс</button>
                <button id="helpButton" onclick="showHelpModal()" class="px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-full transition duration-150 text-sm">?</button>
                <select id="languageSelect" onchange="updateUI()" class="bg-gray-700 text-white rounded-lg p-2 cursor-pointer transition hover:ring-2 ring-red-400">
                    <option value="ru">Русский</option>
                    <option value="en">English</option>
                    <option value="cn">中文</option>
                </select>
            </div>
        </div>
    </header>

    <!-- 2. Main Content Area -->
    <main class="pt-20 pb-4 px-4 max-w-7xl mx-auto min-h-screen">
        
        <!-- Controls Panel -->
        <div class="bg-gray-700 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-[180px]">
                <label for="storyTypeSelect" id="labelStoryType" class="block text-sm font-medium mb-1 text-gray-300">Тип сюжета</label>
                <select id="storyTypeSelect" onchange="updateChapterSelect()" class="w-full bg-gray-800 text-white rounded-lg p-2.5 cursor-pointer focus:ring-red-400 focus:border-red-400 transition">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="flex-1 min-w-[250px]">
                <label for="chapterSelect" id="labelChapter" class="block text-sm font-medium mb-1 text-gray-300">Сюжет (Глава)</label>
                <select id="chapterSelect" onchange="enableLoadButton()" class="w-full bg-gray-800 text-white rounded-lg p-2.5 cursor-pointer focus:ring-red-400 focus:border-red-400 transition">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <button id="loadButton" onclick="updateStoryContent(0)" class="min-w-[120px] bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50" disabled>
                <span id="loadText">Загрузить</span>
            </button>
        </div>

        <!-- 3. Visual Novel Viewer -->
        <div id="vnViewer" class="relative w-full aspect-[16/9] bg-gray-900 rounded-xl shadow-2xl overflow-hidden flex flex-col justify-end transition-colors duration-500" style="min-height: 400px; background-image: url('https://placehold.co/1920x1080/2a2a2a/fca5a5?text=Выбор+сюжета'); background-size: cover; background-position: center; border: 4px solid #fca5a5;">

            <!-- Sprite Container -->
            <div id="spriteContainer" class="absolute inset-0 z-10 pointer-events-none flex justify-center items-end p-4">
                <!-- Sprites are inserted here by JS -->
            </div>

            <!-- Dialogue Box -->
            <div id="dialogueBox" class="vn-overlay p-4 sm:p-6 rounded-lg shadow-2xl z-20 transition-all duration-300 transform translate-y-0 opacity-100 hidden">
                <div id="speakerNameContainer" class="h-6">
                    <div id="currentSpeaker" class="speaker-name text-lg"></div>
                </div>
                
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mt-2">
                    <p id="currentText" class="text-xl sm:text-2xl leading-relaxed transition-opacity duration-300">Текст диалога...</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div id="navButtons" class="absolute bottom-6 right-6 flex space-x-3 z-30 opacity-0 transition-opacity duration-300 hidden">
                <button id="prevButton" onclick="navigateDialogue(-1)" class="bg-gray-800 hover:bg-gray-700 text-white p-3 rounded-full shadow-lg transition duration-150 disabled:opacity-30">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <button id="nextButton" onclick="navigateDialogue(1)" class="bg-red-600 hover:bg-red-500 text-white p-3 rounded-full shadow-lg transition duration-150 disabled:opacity-30">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
            
        </div>

    </main>

    <script>
        const API_KEY = "";
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=" + API_KEY;
        const STORAGE_KEY = 'hg2_story_progress'; // Key for localStorage

        let currentDialogue = [];
        let currentDialogueIndex = 0;
        let dialogueIsLoaded = false;

        // --- I18N DATA ---
        const i18n = {
            ru: {
                headerTitle: "Houkai Gakuen 2 архив сюжета",
                labelStoryType: "Тип сюжета",
                labelChapter: "Сюжет (Глава)",
                loadText: "Загрузить",
                errorFetch: "Ошибка загрузки контента: файл не найден или проблема с сетью.",
                helpTitle: "Как пользоваться архивом:",
                helpText: "Это интерактивный архив сюжетов Honkai Gakuen 2.\n\n1. Используйте верхние выпадающие списки, чтобы выбрать [Тип сюжета] и конкретную [Главу].\n2. Нажмите [Загрузить].\n3. В окне визуальной новеллы используйте кнопки [Далее/Назад] для просмотра диалога. Ваш прогресс автоматически сохраняется."
            },
            en: {
                headerTitle: "Houkai Gakuen 2 Story Archive",
                labelStoryType: "Story Type",
                labelChapter: "Story (Chapter)",
                loadText: "Load",
                resetProgress: "Reset",
                errorFetch: "Content loading error: file not found or network issue.",
                helpTitle: "How to use the Archive:",
                helpText: "This is an interactive story archive for Honkai Gakuen 2.\n\n1. Use the top dropdowns to select the [Story Type] and specific [Chapter].\n2. Click [Load].\n3. In the Visual Novel viewer, use the [Next/Prev] buttons to advance the dialogue. Your progress is saved automatically."
            },
            cn: {
                headerTitle: "崩坏学园2 剧情档案",
                labelStoryType: "剧情类型",
                labelChapter: "剧情 (章节)",
                loadText: "加载",
                resetProgress: "重置",
                errorFetch: "内容加载错误：未找到文件或网络问题。",
                helpTitle: "如何使用档案：",
                helpText: "这是一个崩坏学园2的交互式剧情档案。\n\n1. 使用顶部下拉列表选择剧情类型和特定章节。\n2. 点击加载。\n3. 在视觉小说查看器中，使用下一页/上一页按钮推进对话。您的进度将自动保存。\n4. 点击角色资料或场景分析以获取来自 Gemini API 的实时背景信息。"
            }
        };

        // --- STORY DATA STRUCTURE ---
        const storyData = {
            main: {
                ru: "Основной сюжет", en: "Main Story", cn: "主线剧情",
                chapters: {
                    ch1: { ru: "Глава 1: Выброс Хоукая", en: "Chapter 1: Honkai Eruption", cn: "第一章 崩坏爆发" },
                    ch2: { ru: "Глава 2: Киана наносит ответный удар", en: "Chapter 2: Kiana Strikes Back", cn: "第二章 琪亚娜的反击" },
                    ch3: { ru: "Глава 3: Зловещая молния", en: "Chapter 3: Ominous Lightning", cn: "第三章 邪恶的雷电" }
                }
            },
            extra: {
                ru: "Дополнительный сюжет", en: "Extra Story", cn: "额外剧情",
                chapters: {
                    ex1: { ru: "Экстра 1: Берегись", en: "Extra 1: Beware", cn: "额外 1: 小心" },
                    ex2: { ru: "Экстра 2: Неутолимое желание", en: "Extra 2: Insatiable Desire", cn: "额外 2: 不可满足的欲望" }
                }
            },
            bosses: {
                ru: "Боссы", en: "Bosses", cn: "BOSS",
                chapters: {
                    b1: { ru: "Босс", en: "Boss", cn: "首领" }
                }
            },
            vn: {
                ru: "Визуальная новелла", en: "Visual Novel", cn: "视觉小说",
                chapters: {
                    vn1: { ru: "VN", en: "VN", cn: "视觉小说" }
                }
            },
            romance: {
                ru: "Роман", en: "Romance", cn: "小说",
                chapters: {
                    r1: { ru: "Роман", en: "Novel", cn: "小说" }
                }
            }
        };

        // --- PROGRESS MANAGEMENT ---
        
        /** Saves current progress (language, type, chapter, index) to localStorage. */
        function saveProgress() {
            const progress = {
                lang: document.getElementById('languageSelect').value,
                type: document.getElementById('storyTypeSelect').value,
                chapter: document.getElementById('chapterSelect').value,
                index: currentDialogueIndex
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
        }

        /** Loads progress from localStorage on page load. */
        function loadProgress() {
            const savedProgress = localStorage.getItem(STORAGE_KEY);
            if (!savedProgress) return;

            const progress = JSON.parse(savedProgress);
            
            // Restore language
            const langSelect = document.getElementById('languageSelect');
            if (i18n[progress.lang]) {
                langSelect.value = progress.lang;
            }

            // Restore story type
            const typeSelect = document.getElementById('storyTypeSelect');
            if (storyData[progress.type]) {
                typeSelect.value = progress.type;
            }

            // Must update UI first to populate chapter list
            updateUI(); 

            // Restore chapter
            const chapterSelect = document.getElementById('chapterSelect');
            if (storyData[progress.type]?.chapters[progress.chapter]) {
                chapterSelect.value = progress.chapter;
            }

            // If we have both chapter and type, load content from the saved index
            if (typeSelect.value && chapterSelect.value) {
                // Pass the saved index to updateStoryContent
                updateStoryContent(progress.index);
            }
        }

        /** Clears saved progress and reloads the page. */
        function resetProgress() {
            localStorage.removeItem(STORAGE_KEY);
            document.getElementById('dialogueBox').classList.add('hidden');
            document.getElementById('navButtons').classList.add('hidden');
            // Reset selectors to default
            document.getElementById('languageSelect').value = 'ru';
            updateUI(); 
            // Optional: Show a message to the user that progress was reset
            document.getElementById('vnViewer').style.backgroundImage = `url('https://placehold.co/1920x1080/2a2a2a/fca5a5?text=Прогресс+сброшен.+Выберите+главу.')`;
        }

        // --- CORE UI FUNCTIONS ---

        /** Enables the load button when a chapter is selected. */
        function enableLoadButton() {
            const storyId = document.getElementById('chapterSelect').value;
            document.getElementById('loadButton').disabled = !storyId;
        }

        /** Updates all UI elements based on the current language selection. */
        function updateUI() {
            const lang = document.getElementById('languageSelect').value;
            const text = i18n[lang];

            document.getElementById('headerTitle').textContent = text.headerTitle;
            document.getElementById('labelStoryType').textContent = text.labelStoryType;
            document.getElementById('labelChapter').textContent = text.labelChapter;
            document.getElementById('loadText').textContent = text.loadText;
            document.getElementById('resetButton').textContent = text.resetProgress;
            document.getElementById('contextButton').textContent = text.characterContext;
            document.getElementById('analysisButton').textContent = text.sceneAnalysis;
            document.getElementById('helpContent').innerHTML = `
                <h4 class="text-lg font-semibold text-red-400 mb-2">${text.helpTitle}</h4>
                <p class="whitespace-pre-line">${text.helpText}</p>`;
            
            updateStoryTypeSelect();
            updateChapterSelect();
            enableLoadButton();
        }

        /** Populates the Story Type dropdown based on the current language. */
        function updateStoryTypeSelect() {
            const select = document.getElementById('storyTypeSelect');
            const lang = document.getElementById('languageSelect').value;
            const currentType = select.value;
            
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "---";
            select.appendChild(defaultOption);

            for (const key in storyData) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = storyData[key][lang];
                if (key === currentType) {
                    option.selected = true;
                }
                select.appendChild(option);
            }
        }

        /** Populates the Chapter dropdown based on the selected Story Type and language. */
        function updateChapterSelect() {
            const typeKey = document.getElementById('storyTypeSelect').value;
            const select = document.getElementById('chapterSelect');
            const lang = document.getElementById('languageSelect').value;
            
            select.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "---";
            select.appendChild(defaultOption);

            if (typeKey && storyData[typeKey] && storyData[typeKey].chapters) {
                const chapters = storyData[typeKey].chapters;
                for (const key in chapters) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = chapters[key][lang];
                    select.appendChild(option);
                }
                select.disabled = false;
            } else {
                select.disabled = true;
            }
            enableLoadButton();
        }

        /** Asynchronously loads the selected story chapter JSON and initializes the VN viewer. 
         * @param {number} startIndex - The dialogue index to start viewing from (used for loading progress).
         */
        async function updateStoryContent(startIndex = 0) {
            const storyType = document.getElementById('storyTypeSelect').value;
            const storyId = document.getElementById('chapterSelect').value;
            const currentLang = document.getElementById('languageSelect').value;
            const vnViewer = document.getElementById('vnViewer');
            const loadButton = document.getElementById('loadButton');
            const loadText = document.getElementById('loadText');
            
            if (!storyType || !storyId) return;

            // Filename format: {language}/{type}_{chapter}.json
            const fileName = `story/${currentLang}/${storyType}_${storyId}.json`;

            loadButton.disabled = true;
            loadText.textContent = i18n[currentLang].loadText + '...';
            
            try {
                const response = await fetch(fileName);
                if (!response.ok) {
                    throw new Error(i18n[currentLang].errorFetch + ` (File: ${fileName})`);
                }
                const data = await response.json();
                
                currentDialogue = data.dialogue;
                
                // Set the current index, ensuring it doesn't exceed the dialogue length
                currentDialogueIndex = Math.min(startIndex, currentDialogue.length - 1);
                if (currentDialogueIndex < 0) currentDialogueIndex = 0;

                dialogueIsLoaded = true;

                // Set default VN background if available
                if (currentDialogue.length > 0 && currentDialogue[currentDialogueIndex].background) {
                    vnViewer.style.backgroundImage = `url('${currentDialogue[currentDialogueIndex].background}')`;
                } else {
                    vnViewer.style.backgroundImage = `url('https://placehold.co/1920x1080/2a2a2a/fca5a5?text=${storyData[storyType][currentLang]}')`;
                }

                document.getElementById('dialogueBox').classList.remove('hidden');
                document.getElementById('navButtons').classList.remove('hidden');
                renderDialogue();
                saveProgress(); // Save initial load state

            } catch (error) {
                console.error("Error loading story:", error.message);
                currentDialogue = [];
                dialogueIsLoaded = false;
                vnViewer.style.backgroundImage = `url('https://placehold.co/1920x1080/aa0000/ffffff?text=Ошибка+Загрузки')`;
                document.getElementById('dialogueBox').classList.add('hidden');
                document.getElementById('navButtons').classList.add('hidden');
                alert(error.message); 

            } finally {
                loadButton.disabled = false;
                loadText.textContent = i18n[currentLang].loadText;
            }
        }

        /** Renders the current dialogue line, sprite, and updates navigation buttons. */
        function renderDialogue() {
            if (!dialogueIsLoaded || currentDialogue.length === 0) return;

            const dialogue = currentDialogue[currentDialogueIndex];
            const vnViewer = document.getElementById('vnViewer');
            const spriteContainer = document.getElementById('spriteContainer');
            const currentSpeaker = document.getElementById('currentSpeaker');
            const currentText = document.getElementById('currentText');
            const speakerNameContainer = document.getElementById('speakerNameContainer');
            
            // 1. Update Background
            if (dialogue.background) {
                vnViewer.style.backgroundImage = `url('${dialogue.background}')`;
            }

            // 2. Update Sprite
            spriteContainer.innerHTML = ''; // Clear existing sprites
            if (dialogue.sprite) {
                const img = document.createElement('img');
                img.src = dialogue.sprite;
                img.alt = dialogue.speaker;
                img.classList.add('sprite', dialogue.position === 'left' ? 'left' : 'right');
                img.onerror = () => img.src = `https://placehold.co/200x400/808080/ffffff?text=${dialogue.speaker}`; // Placeholder on error
                spriteContainer.appendChild(img);
            }
            
            // 3. Update Text and Speaker
            currentText.style.opacity = '0';
            setTimeout(() => {
                currentText.textContent = dialogue.text;
                currentText.style.opacity = '1';
            }, 50); // Small delay for fade effect

            if (dialogue.speaker) {
                currentSpeaker.textContent = dialogue.speaker;
                speakerNameContainer.classList.remove('hidden');
            } else {
                currentSpeaker.textContent = '';
                speakerNameContainer.classList.add('hidden');
            }

            // 4. Update Navigation Buttons
            document.getElementById('prevButton').disabled = currentDialogueIndex === 0;
            document.getElementById('nextButton').disabled = currentDialogueIndex >= currentDialogue.length - 1;
            
            // 5. Update LLM buttons visibility
            document.getElementById('contextButton').style.display = dialogue.speaker ? 'block' : 'none';
            document.getElementById('analysisButton').style.display = dialogue.text ? 'block' : 'none';
        }

        /** Handles navigation (next/previous) in the dialogue array. */
        function navigateDialogue(direction) {
            const newIndex = currentDialogueIndex + direction;
            if (newIndex >= 0 && newIndex < currentDialogue.length) {
                currentDialogueIndex = newIndex;
                renderDialogue();
                saveProgress(); // Save progress after navigation
            }
        }

        // --- LLM API INTEGRATION & MODAL ---

        /** Shows the modal with a loading state. */
        function showModal(titleKey) {
            const lang = document.getElementById('languageSelect').value;
            document.getElementById('modalTitle').textContent = i18n[lang][titleKey];
            document.getElementById('modalContent').innerHTML = `
                <div id="modalSpinner" class="flex justify-center items-center py-8">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-red-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-300">${i18n[lang].modalLoading}</p>
                </div>`;
            document.getElementById('llmModal').classList.remove('hidden');
        }

        /** Closes the LLM modal. */
        function closeModal(event = null) {
            if (event && event.target.id !== 'llmModal') return;
            document.getElementById('llmModal').classList.add('hidden');
        }
        
        /** Toggles the help modal. */
        function showHelpModal() {
            document.getElementById('helpModal').classList.toggle('hidden');
        }

        /** Sends a request to the Gemini API for character context or scene analysis. */
        async function handleLLMCall(type) {
            if (!dialogueIsLoaded) return;

            const dialogue = currentDialogue[currentDialogueIndex];
            const currentLang = document.getElementById('languageSelect').value;
            const storyChapterName = document.getElementById('chapterSelect').options[document.getElementById('chapterSelect').selectedIndex].textContent;

            let prompt = "";
            let systemInstruction = "";
            let modalTitleKey = "";

            if (type === 'character' && dialogue.speaker) {
                const speakerName = dialogue.speaker;
                modalTitleKey = 'modalTitleCharacter';
                
                systemInstruction = `Ты эксперт по лору игры Houkai Gakuen 2. Твоя задача — предоставить краткую, увлекательную, но точную справку о персонаже, названном пользователем. Ответ должен быть в одном абзаце на ${currentLang === 'ru' ? 'русском' : (currentLang === 'en' ? 'английском' : 'китайском')} языке.`;
                prompt = `Предоставь краткую биографию и роль в сюжете игры Houkai Gakuen 2 для персонажа по имени: "${speakerName}".`;
                
            } else if (type === 'analysis' && dialogue.text) {
                const sceneText = dialogue.text;
                modalTitleKey = 'modalTitleAnalysis';

                systemInstruction = `Ты литературный аналитик и эксперт по сюжету игры Houkai Gakuen 2. Твоя задача — объяснить важность предоставленного фрагмента диалога (сцены) для общего повествования. Ответ должен быть в одном-двух абзацах на ${currentLang === 'ru' ? 'русском' : (currentLang === 'en' ? 'английском' : 'китайском')} языке.`;
                prompt = `Проанализируй сюжетную значимость следующего фрагмента из главы "${storyChapterName}": "${sceneText}". Объясни, что он означает для персонажей и сюжета.`;
            } else {
                return; // Nothing to analyze
            }

            showModal(modalTitleKey);

            try {
                const response = await fetchWithExponentialBackoff(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                        tools: [{ "google_search": {} }] // Используем Google Search для актуального лора
                    })
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || i18n[currentLang].errorLLM;
                
                document.getElementById('modalContent').innerHTML = `<p class="text-gray-200 whitespace-pre-line">${text}</p>`;

            } catch (error) {
                console.error("LLM fetch error:", error);
                document.getElementById('modalContent').innerHTML = `<p class="text-red-400">${i18n[currentLang].errorLLM}: ${error.message}</p>`;
            }
        }

        /** Helper function for fetch with exponential backoff. */
        async function fetchWithExponentialBackoff(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            loadProgress(); // Try to load saved progress
            updateUI(); // Render UI based on loaded or default language
        };
    </script>
</body>
</html>
