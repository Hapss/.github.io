<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0">
    <title>Houkai Gakuen 2: –ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        /* ==================================================================== */
        /* === –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Dark Theme - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) === */
        /* ==================================================================== */
        :root, .dark-theme {
            /* –§–æ–Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ */
            --color-bg-darkest: #171c26; /* –î–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ */
            --color-bg-main: #1f2937;    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω/—ç–ª–µ–º–µ–Ω—Ç—ã (VN Viewer default) */
            --color-bg-medium: #374151;  /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è/–§–æ–Ω —ç–ª–µ–º–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ */
            
            /* –ê–∫—Ü–µ–Ω—Ç—ã */
            --color-accent-primary: #0891b2; 
            --color-accent-secondary: #0e7490; 
            --color-accent-ring: #22d3ee; 
            --color-warning-accent: #d946ef; 
            --color-warning-bg: #1e1b4b; 
            
            /* –¢–µ–∫—Å—Ç */
            --color-text-primary: #e5e7eb; 
            --color-text-secondary: #d1d5db; 
            
            /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --color-speaker-name: #ca7cfe; 
        }

        /* ==================================================================== */
        /* === –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Light Theme) === */
        /* ==================================================================== */
        .light-theme {
            --color-bg-darkest: #ffffff;  
            --color-bg-main: #f3f4f6;    
            --color-bg-medium: #ffffff;  
            
            --color-accent-primary: #0f766e; 
            --color-accent-secondary: #115e59; 
            --color-accent-ring: #0d9488; 
            
            /* –ê–∫—Ü–µ–Ω—Ç –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */
            --color-warning-accent: #9333ea; 
            --color-warning-bg: #ede9fe; 
            
            /* –¢–µ–∫—Å—Ç */
            --color-text-primary: #111827; 
            --color-text-secondary: #4b5563; 
            
            /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --color-speaker-name: #9333ea; 
        }

        /* ==================================================================== */
        /* === –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º === */
        /* ==================================================================== */
        
        body, #vnViewer, .sprite-image {
            user-select: none;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-drag: none;
            -webkit-user-drag: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg-main); 
            color: var(--color-text-primary);
            transition: background-color 0.3s ease;
        }
        
        .vn-overlay {
            background-color: var(--color-bg-main); 
            opacity: 0.9;
            backdrop-filter: blur(4px);
            color: var(--color-text-primary);
            border: 1px solid var(--color-bg-medium); 
        }
        
        .speaker-name {
            background-color: var(--color-bg-main);
            color: var(--color-speaker-name); 
            padding: 4px 12px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: inline-block;
            font-weight: bold;
            /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–º–µ–Ω–∏ —Å–ø–∏–∫–µ—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            font-size: 1rem; 
        }
        @media (min-width: 768px) {
            .speaker-name {
                font-size: 1.25rem; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            }
        }
        
        .load-button { background-color: var(--color-accent-primary); }
        .load-button:hover { background-color: var(--color-accent-secondary); }
        .alert-message { background-color: var(--color-accent-primary); }
        
        .warning-button {
            background-color: var(--color-warning-accent);
            color: var(--color-text-primary);
            transition: background-color 0.2s;
        }
        .warning-button:hover {
            background-color: var(--color-accent-primary); 
        }

        /* ==================================================================== */
        /* === –ê–î–ê–ü–¢–ò–í–ù–´–ô –î–ò–ê–õ–û–ì–û–í–´–ô –ë–õ–û–ö (MOBILE-FIRST) === */
        /* ==================================================================== */

        /* Wrapper, –∫–æ—Ç–æ—Ä—ã–π —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç —à–∏—Ä–∏–Ω—É (Small Box) */
        #dialogueWrapper {
            /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
            width: 95%; /* –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞ */
            max-width: 95%; 
        }

        @media (min-width: 1024px) {
            #dialogueWrapper {
                /* –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
                width: 900px;
                max-width: 900px;
            }
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–µ–∫—Å—Ç–∞ (Small Box) */
        #dialogueContentBox { 
            /* –í—ã—Å–æ—Ç–∞ –∏ –æ—Ç—Å—Ç—É–ø—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã */
            height: 150px; 
            padding: 1rem;
        }
        @media (min-width: 768px) {
            #dialogueContentBox {
                height: 200px; 
                padding: 2rem;
            }
        }

        /* –¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ (Small Box) */
        #currentText {
            /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            font-size: 1.125rem; /* text-lg */
        }
        @media (min-width: 768px) {
            #currentText {
                /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
                font-size: 1.25rem; /* text-xl */
            }
        }
        
        /* ==================================================================== */
        /* === –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–´–ô –î–ò–ê–õ–û–ì–û–í–´–ô –ë–õ–û–ö (Full Dialogue Box) === */
        /* ==================================================================== */

        #fullDialogueBox {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 30; /* –í—ã—à–µ —Å–ø—Ä–∞–π—Ç–æ–≤, –Ω–∏–∂–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            background-color: var(--color-bg-darkest);
            opacity: 0.95; /* –ù–µ–±–æ–ª—å—à–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            transition: opacity 0.3s ease;
        }
        
        /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º */
        #fullDialogueContent {
            overflow-y: auto;
            padding: 2rem; /* –ë–∞–∑–æ–≤—ã–π –æ—Ç—Å—Ç—É–ø */
            /* –ö–∞—Å—Ç–æ–º–Ω—ã–π Scrollbar */
            scrollbar-width: thin; /* Firefox */
        }

        #fullDialogueContent::-webkit-scrollbar { width: 8px; }
        #fullDialogueContent::-webkit-scrollbar-track { background: var(--color-bg-darkest); border-radius: 10px; }
        #fullDialogueContent::-webkit-scrollbar-thumb { background: var(--color-accent-primary); border-radius: 10px; border: 2px solid var(--color-bg-darkest); }
        #fullDialogueContent::-webkit-scrollbar-thumb:hover { background: var(--color-accent-secondary); }

        /* –†–∞–∑–º–µ—Ä—ã —Ç–µ–∫—Å—Ç–∞ */
        .full-text-sm { font-size: 1.1rem; }
        .full-text-md { font-size: 1.35rem; }
        .full-text-lg { font-size: 1.6rem; }

        /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞: –°–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        .align-top-left { 
            justify-content: flex-start; /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
            align-items: flex-start;    /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ */
            text-align: left;
        }
        
        /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞: –ü–æ —Ü–µ–Ω—Ç—Ä—É */
        .align-center {
            justify-content: center;    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
            align-items: center;       /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ */
            text-align: center;
        }
        
        /* ==================================================================== */
        /* === –°–ü–†–ê–ô–¢–´ –ò –§–û–ù === */
        /* ==================================================================== */
        
        .sprite-position {
            position: absolute;
            bottom: 0; 
            height: 95%; 
            /* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É —Å–ø—Ä–∞–π—Ç–∞, —á—Ç–æ–±—ã –æ—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            width: 40%;
            transition: opacity 0.5s ease; 
            z-index: 10;
            display: flex; 
            justify-content: center;
            align-items: flex-end;
        }
        @media (min-width: 768px) {
            .sprite-position {
                width: 45%; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
            }
        }

        .sprite-position.left { left: 0; }
        .sprite-position.right { right: 0; }
        
        .sprite-image {
            height: 100%; 
            width: auto;
            max-height: 100%; 
            object-fit: contain;
            display: block; 
            transition: opacity 0.3s ease, filter 0.3s ease; 
            opacity: 1; 
        }
        
        .dimmed-sprite {
            /* –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤ 30% —è—Ä–∫–æ—Å—Ç–∏ –∏ 30% —Å–µ—Ä–æ–≥–æ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–º–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ */
            filter: brightness(0.3) grayscale(30%) !important; 
            opacity: 1 !important; 
        }
        
        .bg-layer {
            transition: opacity 1.0s ease; 
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
        }

        /* ==================================================================== */
        /* === –ò–°–¢–û–†–ò–Ø –î–ò–ê–õ–û–ì–û–í (–û–ö) === */
        /* ==================================================================== */
        
        #historyPanel.open {
            transform: translateX(0); 
        }
        #historyPanel {
            right: 0; 
            left: auto; 
            top: 0;
            transform: translateX(100%); 
            transition: transform 0.3s ease; 
            z-index: 50; 
            width: 100%; 
            max-width: 90vw; /* –ü–æ—á—Ç–∏ –ø–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            display: flex;
            flex-direction: column;
        }
        @media (min-width: 768px) {
            #historyPanel {
                max-width: 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ */
            }
        }
        
        #historyContent {
            flex-grow: 1; 
            overflow-y: auto; 
            padding-bottom: 2rem; 
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π Scrollbar */
        #historyContent::-webkit-scrollbar { width: 8px; }
        #historyContent::-webkit-scrollbar-track { background: var(--color-bg-medium); border-radius: 10px; }
        #historyContent::-webkit-scrollbar-thumb { background: var(--color-accent-primary); border-radius: 10px; border: 2px solid var(--color-bg-darkest); }
        #historyContent::-webkit-scrollbar-thumb:hover { background: var(--color-accent-secondary); }
    </style>
</head>
<body class="min-h-screen dark-theme">
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                getFirestore(app);

                async function authenticate() {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("[Firebase] –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                    }
                }
                authenticate();
            } catch (e) {
                console.error("[Firebase] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", e);
            }
        }
    </script>
    
    <!-- 1. Header Bar: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
    <header id="header" class="fixed top-0 left-0 right-0 z-50 p-3 md:p-4 shadow-xl transition-colors duration-300" style="background-color: var(--color-bg-darkest);">
        <div class="flex flex-wrap justify-between items-center max-w-7xl mx-auto">
            <!-- –£–î–ê–õ–ï–ù–û: –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä –∏ —Å—á–µ—Ç—á–∏–∫ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã -->
            <div class="flex items-center space-x-3">
                <h1 id="headerTitle" class="text-lg md:text-xl font-bold tracking-wider mb-2 md:mb-0" style="color: var(--color-text-primary);">Houkai Gakuen 2: –ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞</h1>
            </div>
            
            <div class="flex items-center space-x-2 md:space-x-4">
                 <!-- –ö–Ω–æ–ø–∫–∞ –ò—Å—Ç–æ—Ä–∏–∏ -->
                <button id="historyToggle" onclick="toggleHistory()" class="px-2 py-1 text-xs md:text-sm rounded-full transition duration-150" style="background-color: var(--color-bg-medium); color: var(--color-text-primary);">
                    <span id="historyText">–ò—Å—Ç–æ—Ä–∏—è</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã -->
                <button id="themeToggle" onclick="toggleTheme()" class="px-2 py-1 text-xs md:text-sm rounded-full transition duration-150" style="background-color: var(--color-bg-medium); color: var(--color-text-primary);">
                    <span id="themeIcon">üåô</span> <span id="themeText">–¢–µ–º–Ω–∞—è</span>
                </button>

                <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ (–î–æ–±–∞–≤–ª–µ–Ω RU –∏ ZH) -->
                <select id="languageSelect" onchange="initializeOrUpdateUI(true)" class="select-field rounded-lg p-1 md:p-2 cursor-pointer transition hover:ring-2 text-xs md:text-sm" style="background-color: var(--color-bg-medium);">
                    <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
                    <option value="zh">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                </select>
            </div>
        </div>
    </header>
    
    <!-- –ü–∞–Ω–µ–ª—å –ò—Å—Ç–æ—Ä–∏–∏ –î–∏–∞–ª–æ–≥–æ–≤ (–ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≤ CSS) -->
    <div id="historyPanel" class="fixed top-0 h-full z-50 p-4 pt-20 shadow-2xl transition-transform duration-300" 
         style="background-color: var(--color-bg-darkest); opacity: 0.95;">
        <h2 id="historyTitle" class="text-xl font-bold mb-4" style="color: var(--color-text-primary);">–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤</h2>
        <div id="historyContent" class="space-y-3" style="height: calc(100% - 3.5rem);">
            <!-- History items here -->
        </div>
        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ -->
        <button onclick="toggleHistory()" class="absolute top-4 right-4 text-xl p-2 rounded-full hover:bg-gray-700 transition" style="color: var(--color-text-primary);">
            &times;
        </button>
    </div>

    <!-- 2. Main Content Area -->
    <main id="mainContent" class="pt-[6rem] md:pt-20 pb-4 px-2 md:px-4 max-w-7xl mx-auto min-h-screen">
        
        <!-- Controls Panel: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç flex-wrap –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
        <div class="control-panel p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-3 md:gap-4 items-end transition-colors duration-300" style="background-color: var(--color-bg-medium);">
            <!-- –í—ã–±–æ—Ä –¢–∏–ø–∞ –°—é–∂–µ—Ç–∞ -->
            <div class="flex-1 min-w-[45%] md:min-w-[180px]">
                <label for="storyTypeSelect" id="labelStoryType" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);">–¢–∏–ø —Å—é–∂–µ—Ç–∞</label>
                <!-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–∏–ø–∞ -->
                <select id="storyTypeSelect" onchange="updateArcAndChapterUI()" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition text-sm" style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- –í—ã–±–æ—Ä –ê—Ä–∫–∏ -->
            <div id="arcSelectContainer" class="flex-1 min-w-[45%] md:min-w-[180px] hidden">
                <label for="arcSelect" id="labelArc" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);">–ê—Ä–∫–∞</label>
                 <!-- –í—ã–∑–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–ª–∞–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∞—Ä–∫–∏ -->
                <select id="arcSelect" onchange="updateChapterSelect()" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition text-sm" style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <!-- –í—ã–±–æ—Ä –ì–ª–∞–≤—ã -->
            <div class="w-full md:flex-1 md:min-w-[250px]">
                <label for="chapterSelect" id="labelChapter" class="block text-sm font-medium mb-1" style="color: var(--color-text-secondary);"></label>
                <select id="chapterSelect" onchange="enableLoadButton()" class="select-field w-full rounded-lg p-2.5 cursor-pointer focus:ring-4 transition text-sm" disabled style="background-color: var(--color-bg-main);">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <button id="loadButton" onclick="updateStoryContent()" class="w-full md:w-auto min-w-[120px] load-button text-white font-bold py-2.5 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50 text-sm md:text-base" disabled>
                <span id="loadText">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
            </button>
        </div>

        <!-- 3. Visual Novel Viewer (Main View) -->
        <div id="vnViewer" class="relative w-full aspect-[16/9] rounded-xl shadow-2xl overflow-hidden flex flex-col justify-end transition-colors duration-500 cursor-pointer" 
             style="min-height: 400px; background-color: var(--color-bg-main);"
             onclick="navigateDialogue(1)"> 
            
            <!-- Background Layers Container -->
            <div id="backgroundContainer" class="absolute inset-0 z-0">
                <div id="bgLayer1" class="absolute inset-0 bg-layer opacity-100"></div>
                <div id="bgLayer2" class="absolute inset-0 bg-layer opacity-0"></div>
            </div>

            <!-- Sprite Container -->
            <div id="spriteContainer" class="absolute inset-0 z-10 pointer-events-none flex justify-center items-end p-2 md:p-4">
                
                <div id="spriteLeftContainer" class="sprite-position left hidden">
                    <img id="spriteLeft" class="sprite-image" src="" alt="–õ–µ–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" ondragstart="return false;">
                </div>
                
                <div id="spriteRightContainer" class="sprite-position right hidden">
                    <img id="spriteRight" class="sprite-image" src="" alt="–ü—Ä–∞–≤—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂" ondragstart="return false;">
                </div>
            </div>

            <!-- 3a. Small Dialogue Wrapper (Original) -->
            <div id="dialogueWrapper" class="absolute bottom-2 md:bottom-4 left-1/2 -translate-x-1/2 z-20 transition-all duration-300 opacity-100 hidden">
                
                <!-- Speaker Name Container -->
                <div id="speakerNameContainer" class="text-left mb-0 ml-4 md:ml-8"> 
                    <div id="currentSpeaker" class="speaker-name rounded-t-lg rounded-b-none"></div>
                </div>
                
                <!-- Dialogue Text Content Box (height and padding are adaptive in CSS) -->
                <div id="dialogueContentBox" 
                    class="vn-overlay rounded-xl shadow-2xl overflow-hidden flex items-start justify-start text-left"> 
                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç innerHTML –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ <br> -->
                    <p id="currentText" class="leading-tight transition-opacity duration-300">–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞...</p>
                </div>
            </div>

            <!-- 3b. Full Dialogue Box (New) -->
            <div id="fullDialogueBox" class="hidden">
                <!-- Inner content to handle flex alignment -->
                <div id="fullDialogueContent" class="h-full w-full flex flex-col p-4 md:p-8">
                    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç innerHTML –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ <br> -->
                    <p id="fullCurrentText" class="leading-relaxed transition-opacity duration-300"></p>
                </div>
            </div>
            
            <!-- –ù–û–í–û–ï: –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã -->
            <div id="chapter-load-overlay" class="absolute inset-0 z-40 flex flex-col items-center justify-center transition-opacity duration-300 hidden" style="background-color: rgba(23, 28, 38, 0.9);">
                <div class="w-12 h-12 border-4 border-t-transparent border-cyan-400 rounded-full animate-spin"></div>
                <p id="chapter-load-progress" class="mt-4 text-white font-mono text-lg"></p>
            </div>
            
        </div>
    </main>
    
    <!-- 4. –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (Modal Overlay) -->
    <div id="warning-overlay" class="fixed inset-0 z-[100] bg-gray-900/95 flex items-center justify-center p-4 md:p-8 transition-opacity duration-500 opacity-100">
        
        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: —É–≤–µ–ª–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–æ lg:max-w-4xl –¥–ª—è –ü–ö -->
        <div id="warning-card" class="p-8 md:p-12 rounded-3xl shadow-2xl max-w-sm lg:max-w-4xl w-full text-center 
                    transform scale-100 transition-transform duration-300 border-2" 
                    style="background-color: var(--color-warning-bg); border-color: var(--color-warning-accent); color: var(--color-text-primary);">

            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫: –ò–∑–º–µ–Ω–µ–Ω –Ω–∞ "–ü–†–ò–ú–ï–ß–ê–ù–ò–ï" -->
            <h1 id="warningTitleText" class="text-4xl md:text-7xl font-extrabold mb-6 select-none tracking-tight" 
                style="color: var(--color-warning-accent);">
                –ü–†–ò–ú–ï–ß–ê–ù–ò–ï
            </h1>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è -->
            <p class="text-base md:text-xl mb-3 font-medium leading-relaxed" 
               style="color: var(--color-text-secondary);">
                –≠—Ç–æ —Ñ–∞–Ω–∞—Ç—Å–∫–∏–π –∞—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞ Guns Girl Z (Honkai Gakuen 2). –í—Å–µ –ø—Ä–∞–≤–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç miHoYo.
            </p>

            <!-- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ -->
            <p class="text-sm md:text-base mb-1 font-medium" 
               style="color: var(--color-text-secondary);">
                –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω Haps.
            </p>
            <p class="text-sm md:text-base mb-8 font-medium" 
               style="color: var(--color-text-secondary);">
                –°–∞–π—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω —Å –ø–æ–º–æ—â—å—é Gemini.
            </p>

            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è -->
            <button id="close-warning-button" 
                    onclick="dismissWarningModal()"
                    class="warning-button font-bold py-3 px-8 text-base md:text-lg rounded-full 
                           transition duration-200 ease-in-out shadow-xl hover:shadow-2xl 
                           focus:outline-none focus:ring-4" 
                           style="background-color: var(--color-warning-accent);">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>


    <script>
        // ====================================================================
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï ===
        // ====================================================================
        
        const CONFIG = {
            PATHS: {
                SPRITE_BASE: 'images/sprites/',
                BACKGROUND_BASE: 'images/background/',
                METADATA_FILE: 'story/story_metadata.json', 
                STORY_BASE: 'story/', // –¢–µ–ø–µ—Ä—å –æ–∂–∏–¥–∞–µ—Ç—Å—è –ø–∞–ø–∫–∞ —è–∑—ã–∫–∞: story/ru/ –∏–ª–∏ story/zh/
            },
            STORAGE: {
                THEME_KEY: 'vn_theme',
                WARNING_KEY: 'vn_warning_dismissed',
                LANG_KEY: 'vn_lang', // –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞
            },
            BACKOFF: {
                INITIAL_DELAY_MS: 750,  
                MAX_DELAY_MS: 7500,     
                MAX_ATTEMPTS: 3,        
            },
            PLACEHOLDERS: {
                DEFAULT_BG_COLOR: '#1f2937', 
            }
        };

        const STORY_GROUPS = {
            main: { zh: "‰∏ªÁ∫øÂâßÊÉÖ", ru: "–û—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç", prefix: "main_" },
            extra: { zh: "È¢ùÂ§ñÂâßÊÉÖ", ru: "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—é–∂–µ—Ç", prefix: "extra_" },
            bosses: { zh: "Boss ÂÖ≥Âç°", ru: "–ë–æ—Å—Å—ã", prefix: "boss_" },
            vn: { zh: "ËßÜËßâÂ∞èËØ¥", ru: "–í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–æ–≤–µ–ª–ª–∞", prefix: "vn_" },
            romance: { zh: "ÊÅãÁà±Â∞èËØ¥", ru: "–õ—ë–≥–∫–∞—è –Ω–æ–≤–µ–ª–ª–∞", prefix: "ln_" }
        };
        
        const MAIN_STORY_ARCS = {
            re: { zh: "ËøΩÂøÜÁØá", ru: "–†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç—Ä" },
            in: { zh: "ÈÅóÊÑøÁØá", ru: "–ù–∞—Å–ª–µ–¥–∏–µ" },
            fm: { zh: "ËõæÁÅ´ÁØá", ru: "–û–≥–Ω–µ–Ω–Ω—ã–π –ú–æ—Ç—ã–ª—ë–∫" },
            nl: { zh: "Êñ∞ÁîüÁØá", ru: "–ù–æ–≤–∞—è –∂–∏–∑–Ω—å" },
            ah: { zh: "Â¥©ÂùèÂ≠¶Âõ≠ÁØá", ru: "–ê–∫–∞–¥–µ–º–∏—è –•–æ—É–∫–∞—è" }
        };

        let currentLang = localStorage.getItem(CONFIG.STORAGE.LANG_KEY) || 'ru'; // –†—É—Å—Å–∫–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        
        let currentDialogue = []; 
        let currentDialogueIndex = 0;
        let dialogueIsLoaded = false;
        let currentBackgroundUrl = null; 
        window.storyMetadata = null; 
        let isHistoryVisible = false; 
        let activeBgLayer = 1; // 1 or 2
        
        let currentLeftSpriteFile = null;
        let currentRightSpriteFile = null;
        
        let preloadedAssets = {}; 

        const i18n = {
            ru: {
                headerTitle: "Houkai Gakuen 2: –ê—Ä—Ö–∏–≤ —Å—é–∂–µ—Ç–∞", labelStoryType: "–¢–∏–ø —Å—é–∂–µ—Ç–∞", labelArc: "–ê—Ä–∫–∞", labelChapter: "–ì–ª–∞–≤–∞",
                loadText: "–ó–∞–≥—Ä—É–∑–∏—Ç—å", loadingText: "–ó–∞–≥—Ä—É–∑–∫–∞...", loadedText: "–ó–∞–≥—Ä—É–∂–µ–Ω–æ", 
                errorLoading: "–ü–æ–≤—Ç–æ—Ä", endOfStory: "–ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏!",
                startOfStory: "–≠—Ç–æ –Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏.", placeholderMetadata: "--- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã ---",
                placeholderSelectArc: "--- –í—ã–±–µ—Ä–∏—Ç–µ –ê—Ä–∫—É ---", 
                errorFetchMetadataStrict: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≥–ª–∞–≤. –§–∞–π–ª story/story_metadata.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.",
                errorChapterNotFound: "–§–∞–π–ª –≥–ª–∞–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                errorJsonSyntax: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ JSON: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON –≥–ª–∞–≤—ã (–ª–∏—à–Ω–∏–µ –∑–∞–ø—è—Ç—ã–µ/—Å–∫–æ–±–∫–∏)!",
                errorRender: (msg) => `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ${msg}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö!`, 
                themeDark: "–¢–µ–º–Ω–∞—è", themeLight: "–°–≤–µ—Ç–ª–∞—è",
                historyTitle: "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤", historyButton: "–ò—Å—Ç–æ—Ä–∏—è", historyEmpty: "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.",
                placeholderSelectType: "--- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å—é–∂–µ—Ç–∞ ---",
                narrativePlaceholder: "[–ü–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ]",
                scenePlaceholder: "–°—Ü–µ–Ω–∞: "
            },
            zh: {
                headerTitle: "Â¥©ÂùèÂ≠¶Âõ≠2 ÂâßÊÉÖÂΩíÊ°£", labelStoryType: "ÂâßÊÉÖÁ±ªÂûã", labelArc: "ÁØáÁ´†", labelChapter: "Á´†ËäÇ",
                loadText: "Âä†ËΩΩ", loadingText: "Ê≠£Âú®Âä†ËΩΩ...", loadedText: "Â∑≤Âä†ËΩΩ", 
                errorLoading: "ÈáçËØï", endOfStory: "ÂâßÊÉÖÁªìÊùü!",
                startOfStory: "ËøôÊòØÂâßÊÉÖÁöÑÂºÄÂßã„ÄÇ", placeholderMetadata: "--- ÂÖÉÊï∞ÊçÆÊú™Âä†ËΩΩ ---",
                placeholderSelectArc: "--- ËØ∑ÂÖàÈÄâÊã©ÁØáÁ´† ---", 
                errorFetchMetadataStrict: "Ëá¥ÂëΩÈîôËØØ: Êó†Ê≥ïÂä†ËΩΩÁ´†ËäÇÂÖÉÊï∞ÊçÆ„ÄÇÊñá‰ª∂ story/story_metadata.json Áº∫Â§±Êàñ‰∏çÂèØÁî®„ÄÇ",
                errorChapterNotFound: "Á´†ËäÇÊñá‰ª∂Êú™ÊâæÂà∞„ÄÇ",
                errorJsonSyntax: "JSON Ëá¥ÂëΩÈîôËØØ: ËØ∑Ê£ÄÊü•Á´†ËäÇ JSON Êñá‰ª∂ÁªìÊûÑ (Â§ö‰ΩôÁöÑÈÄóÂè∑/Êã¨Âè∑)!",
                errorRender: (msg) => `Ê∏≤ÊüìËá¥ÂëΩÈîôËØØ: ${msg}„ÄÇËØ∑Ê£ÄÊü•Êï∞ÊçÆÁªìÊûÑ!`, 
                themeDark: "ÈªëÊöó", themeLight: "Êòé‰∫Æ",
                historyTitle: "ÂØπËØùÂéÜÂè≤", historyButton: "ÂéÜÂè≤", historyEmpty: "ÂéÜÂè≤ËÆ∞ÂΩï‰∏∫Á©∫„ÄÇ",
                placeholderSelectType: "--- ËØ∑ÂÖàÈÄâÊã©ÂâßÊÉÖÁ±ªÂûã ---",
                narrativePlaceholder: "[Âèô‰∫ã]",
                scenePlaceholder: "Âú∫ÊôØ: "
            }
        };

        let elements = {};

        // ====================================================================
        // === –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–û–ô –ó–ê–ì–†–£–ó–ö–ò (PRELOADING UTILITIES) ===
        // ====================================================================
        
        function loadImage(url) {
            if (preloadedAssets[url]) {
                return preloadedAssets[url];
            }

            const promise = new Promise((resolve, reject) => {
                const img = new Image();
                
                img.onload = () => {
                    resolve(img);
                };
                
                img.onerror = () => {
                    console.warn(`[Preload] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${url}`);
                    reject(new Error(`Failed to load image: ${url}`)); 
                };

                img.src = url; 
            });

            preloadedAssets[url] = promise;
            return promise;
        }

        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ "—Å–ª–µ–¥—É—é—â–µ–≥–æ" —à–∞–≥–∞,
        // —Ç–∞–∫ –∫–∞–∫ –º—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å—é –≥–ª–∞–≤—É —Å—Ä–∞–∑—É. –ù–æ –æ–Ω–∞ –±–µ–∑–≤—Ä–µ–¥–Ω–∞.
        async function preloadAssets(index) {
            if (index < 0 || index >= currentDialogue.length) return Promise.resolve([]);
            
            const step = currentDialogue[index];
            const loadPromises = [];
            
            if (step.background) {
                const bgUrl = CONFIG.PATHS.BACKGROUND_BASE + encodeURIComponent(step.background);
                loadPromises.push(loadImage(bgUrl).catch(() => null)); 
            }
            
            if (step.sprite_left) {
                const spriteUrl = spritePath(step.sprite_left);
                loadPromises.push(loadImage(spriteUrl).catch(() => null));
            }
            
            if (step.sprite_right) {
                const spriteUrl = spritePath(step.sprite_right);
                loadPromises.push(loadImage(spriteUrl).catch(() => null));
            }

            return Promise.all(loadPromises);
        }

        // –£–î–ê–õ–ï–ù–û: –§—É–Ω–∫—Ü–∏—è aggressivePreload() –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞.

        // ====================================================================
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–ï–ú–ê–ú–ò –∏ –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï–ú (UX) ===
        // ====================================================================

        function saveTheme(theme) {
            localStorage.setItem(CONFIG.STORAGE.THEME_KEY, theme);
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const isDark = theme === 'dark';
            
            document.body.classList.toggle('light-theme', !isDark);
            document.body.classList.toggle('dark-theme', isDark);

            if (elements.themeIcon && elements.themeText) {
                elements.themeIcon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
                elements.themeText.textContent = isDark ? i18n[currentLang].themeDark : i18n[currentLang].themeLight;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
            const card = document.getElementById('warning-card');
            if (card) {
                const style = getComputedStyle(document.body);
                const accentColor = style.getPropertyValue('--color-warning-accent').trim();
                const bgColor = style.getPropertyValue('--color-warning-bg').trim();
                const secondaryTextColor = style.getPropertyValue('--color-text-secondary').trim();
                
                card.style.backgroundColor = bgColor;
                card.style.borderColor = accentColor;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
                const warningTitleText = document.getElementById('warningTitleText');
                if (warningTitleText) warningTitleText.style.color = accentColor;
                
                card.querySelectorAll('p').forEach(p => p.style.color = secondaryTextColor);

                const closeButton = card.querySelector('#close-warning-button');
                closeButton.style.backgroundColor = accentColor;
                closeButton.style.color = 'white'; 
                
                const overlay = document.getElementById('warning-overlay');
                overlay.style.backgroundColor = isDark ? 'rgba(15, 23, 42, 0.95)' : 'rgba(241, 245, 249, 0.95)';
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞ VN
            if (currentBackgroundUrl === CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR) {
                 const style = getComputedStyle(document.body);
                 const themeBgColor = style.getPropertyValue('--color-bg-main').trim();
                 
                 const activeLayer = activeBgLayer === 1 ? elements.bgLayer1 : elements.bgLayer2;
                 const inactiveLayer = activeBgLayer === 1 ? elements.bgLayer2 : elements.bgLayer1;

                 activeLayer.style.backgroundColor = themeBgColor;
                 inactiveLayer.style.backgroundColor = themeBgColor;
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            saveTheme(newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(CONFIG.STORAGE.THEME_KEY) || 'dark'; 
            applyTheme(savedTheme);
        }
        
        function handleWarningModalState() {
            const { warningOverlay } = elements;
            
            const isDismissed = localStorage.getItem(CONFIG.STORAGE.WARNING_KEY) === 'true';

            if (isDismissed) {
                warningOverlay.style.display = 'none';
                return;
            }
        }
        
        function dismissWarningModal() {
            const overlay = elements.warningOverlay;
            if (!overlay) return;
            
            localStorage.setItem(CONFIG.STORAGE.WARNING_KEY, 'true');
            
            overlay.style.opacity = '0';
            
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 500); 
        }


        // ====================================================================
        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
            elements.languageSelect = document.getElementById('languageSelect');
            elements.storyTypeSelect = document.getElementById('storyTypeSelect');
            elements.arcSelectContainer = document.getElementById('arcSelectContainer');
            elements.arcSelect = document.getElementById('arcSelect');
            elements.chapterSelect = document.getElementById('chapterSelect');
            elements.loadButton = document.getElementById('loadButton');
            elements.loadText = document.getElementById('loadText');
            elements.vnViewerElement = document.getElementById('vnViewer');
            
            // --- –≠–ª–µ–º–µ–Ω—Ç—ã –ú–∞–ª–æ–≥–æ –î–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –û–∫–Ω–∞ (Small Box) ---
            elements.dialogueWrapper = document.getElementById('dialogueWrapper');
            elements.currentSpeaker = document.getElementById('currentSpeaker');
            elements.currentText = document.getElementById('currentText');
            elements.speakerNameContainer = document.getElementById('speakerNameContainer');
            
            // --- –≠–ª–µ–º–µ–Ω—Ç—ã –ü–æ–ª–Ω–æ–≥–æ –î–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –û–∫–Ω–∞ (Full Box) ---
            elements.fullDialogueBox = document.getElementById('fullDialogueBox');
            elements.fullDialogueContent = document.getElementById('fullDialogueContent');
            elements.fullCurrentText = document.getElementById('fullCurrentText');

            elements.spriteLeftContainer = document.getElementById('spriteLeftContainer');
            elements.spriteRightContainer = document.getElementById('spriteRightContainer');
            elements.spriteLeftElement = document.getElementById('spriteLeft');
            elements.spriteRightElement = document.getElementById('spriteRight');
            elements.bgLayer1 = document.getElementById('bgLayer1');
            elements.bgLayer2 = document.getElementById('bgLayer2');
            elements.themeIcon = document.getElementById('themeIcon');
            elements.themeText = document.getElementById('themeText');
            elements.historyPanel = document.getElementById('historyPanel');
            elements.historyContent = document.getElementById('historyContent');
            elements.historyTitle = document.getElementById('historyTitle');
            elements.historyButton = document.getElementById('historyToggle');
            elements.historyText = document.getElementById('historyText');
            elements.mainContent = document.getElementById('mainContent'); 
            elements.warningOverlay = document.getElementById('warning-overlay');
            elements.closeWarningButton = document.getElementById('close-warning-button');

            // --- –≠–ª–µ–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ –≥–ª–∞–≤—ã ---
            elements.chapterLoadOverlay = document.getElementById('chapter-load-overlay');
            elements.chapterLoadProgress = document.getElementById('chapter-load-progress');
            

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Ñ–æ–Ω–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ª–æ–π (—Ü–≤–µ—Ç)
            elements.bgLayer1.style.backgroundColor = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR;
            elements.bgLayer1.style.backgroundImage = 'none';
            currentBackgroundUrl = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR; 
            
            loadTheme(); 
            handleWarningModalState(); 
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
            await fetchChapterMetadata();
            initializeOrUpdateUI(); 
            // aggressivePreload(); // –£–î–ê–õ–ï–ù–û

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ò—Å—Ç–æ—Ä–∏–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –ø–∞–Ω–µ–ª–∏
            document.addEventListener('click', (event) => {
                const historyPanel = elements.historyPanel;
                const historyToggle = elements.historyButton;
                
                if (isHistoryVisible) {
                    if (!historyPanel.contains(event.target) && !historyToggle.contains(event.target)) {
                        toggleHistory(); 
                    }
                }
            });
        });

        // ====================================================================
        // === CORE FUNCTIONS (–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –†–µ–Ω–¥–µ—Ä–∏–Ω–≥) ===
        // ====================================================================
        
        async function fetchChapterMetadata() {
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–†–£–°–°–ö–ò–ï/–ö–ò–¢–ê–ô–°–ö–ò–ï –ü–õ–ï–ô–°–•–û–õ–î–ï–†–´)
            const chapterPlaceholders = {
                "re_main_ch1": { ru: "–ü—Ä–æ–ª–æ–≥: –ù–∞—á–∞–ª–æ", zh: "Â∫èÁ´†: ÂºÄÂßã" },
                "re_main_ch2": { ru: "–ì–ª–∞–≤–∞ 2: –ü–æ–∏—Å–∫", zh: "Á¨¨2Á´†: ÊêúÂØª" },
                "re_main_ch3": { ru: "–ì–ª–∞–≤–∞ 3: –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ", zh: "Á¨¨3Á´†: ÂΩíÊù•" },
                "re_main_ch11": { ru: "–ì–ª–∞–≤–∞ 11: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —É–≥—Ä–æ–∑–∞", zh: "Á¨¨11Á´†: Êú™Áü•Â®ÅËÉÅ" }, // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                "in_main_ch1": { ru: "–ì–ª–∞–≤–∞ –ó–∞–≤–µ—â–∞–Ω–∏—è 1", zh: "ÈÅóÊÑøÁØá 1" },
                "in_main_ch2": { ru: "–ì–ª–∞–≤–∞ –ó–∞–≤–µ—â–∞–Ω–∏—è 2", zh: "ÈÅóÊÑøÁØá 2" },
                "extra_01": { ru: "–°–æ–±—ã—Ç–∏–µ: –ü–ª—è–∂", zh: "Ê¥ªÂä®: Êµ∑Êª©" },
                "extra_02": { ru: "–°–æ–±—ã—Ç–∏–µ: –ó–∏–º–Ω–∏–π –±–∞–ª", zh: "Ê¥ªÂä®: ÂÜ¨Êó•Ëàû‰ºö" },
                "boss_01": { ru: "–ë–æ—Å—Å: –ö–æ—Ä–æ–ª–µ–≤–∞ –∑–æ–º–±–∏", zh: "Boss: ÂÉµÂ∞∏Â•≥Áéã" },
            };
            
            try {
                const response = await fetch(CONFIG.PATHS.METADATA_FILE); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                window.storyMetadata = await response.json();
                
            } catch (error) {
                console.warn(`[Metadata] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å story_metadata.json. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∏.`, error);
                
                // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–≥–ª—É—à–µ–∫, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–≥–ª–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É
                window.storyMetadata = chapterPlaceholders; 
            }
        }

        function navigateDialogue(direction) {
            if (isHistoryVisible) return;
            
            try { 
                if (!dialogueIsLoaded || currentDialogue.length === 0) return;
                
                const newIndex = currentDialogueIndex + direction;
                const lang = currentLang; 

                if (newIndex >= 0 && newIndex < currentDialogue.length) {
                    currentDialogueIndex = newIndex;
                    renderDialogueStep();
                    
                    // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è, –æ–Ω–∞ –Ω–µ –º–µ—à–∞–µ—Ç
                    if (direction > 0) { 
                        preloadAssets(currentDialogueIndex + 1);
                    }

                } else if (newIndex >= currentDialogue.length) {
                    alertMessage(i18n[lang].endOfStory);
                    currentDialogueIndex = currentDialogue.length - 1;
                } else {
                    alertMessage(i18n[lang].startOfStory);
                }
            } catch (e) {
                 console.error("[Dialogue Navigation] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è:", e);
                 alertMessage(i18n[currentLang].errorRender(e.message));
            }
        }
        
        const spritePath = (fileName) => {
            if (!fileName) return null;
            const encodedFileName = encodeURIComponent(fileName);
            // –í–æ–∑–≤—Ä–∞—Ç –ø—É—Ç–∏ –∫ —Å–ø—Ä–∞–π—Ç—É
            return CONFIG.PATHS.SPRITE_BASE + encodedFileName; 
        };
        
        async function loadSprite(url, element, container) {
            if (!url) {
                container.classList.add('hidden');
                element.src = '';
                return;
            }
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ (–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å, –µ—Å–ª–∏ –Ω–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–æ)
                const loadedImage = await loadImage(url); 

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ src –∏–∑ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Image, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω (–ú–ì–ù–û–í–ï–ù–ù–û)
                element.src = loadedImage.src; 
                container.classList.remove('hidden');

            } catch (error) {
                container.classList.add('hidden');
                console.warn(`[Sprite Load] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø—Ä–∞–π—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${url}.`, error);
                element.src = ''; 
            }
        }

        async function crossFadeBackground(newBgFileName) {
            const encodedBgFileName = encodeURIComponent(newBgFileName);
            const finalBgUrl = CONFIG.PATHS.BACKGROUND_BASE + encodedBgFileName;
            
            if (finalBgUrl === currentBackgroundUrl) return; 

            const { bgLayer1, bgLayer2 } = elements;
            const nextLayer = activeBgLayer === 1 ? bgLayer2 : bgLayer1;
            const currentLayer = activeBgLayer === 1 ? bgLayer1 : bgLayer2;
            
            try {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –∫—ç—à–∞ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞ (–∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å)
                const loadedImage = await loadImage(finalBgUrl); 

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–∞ –∏–∑ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ Image, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
                nextLayer.style.backgroundImage = `url('${loadedImage.src}')`;
                nextLayer.style.backgroundColor = 'transparent'; 
                
                // –ö—Ä–æ—Å—Å—Ñ–µ–π–¥
                setTimeout(() => {
                    currentLayer.style.opacity = '0';
                    nextLayer.style.opacity = '1';
                    
                    activeBgLayer = activeBgLayer === 1 ? 2 : 1;
                    currentBackgroundUrl = loadedImage.src;
                }, 10);
                
            } catch (error) {
                console.warn(`[BG Fade] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ–Ω: ${finalBgUrl}. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.`);
                
                 setTimeout(() => {
                    nextLayer.style.backgroundImage = 'none';
                    const themeBgColor = getComputedStyle(document.body).getPropertyValue('--color-bg-main').trim();

                    nextLayer.style.backgroundColor = themeBgColor;

                    currentLayer.style.opacity = '0';
                    nextLayer.style.opacity = '1';

                    activeBgLayer = activeBgLayer === 1 ? 2 : 1;
                    currentBackgroundUrl = CONFIG.PLACEHOLDERS.DEFAULT_BG_COLOR;
                }, 10);
            }
        }
        
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ —Å—Ç—Ä–æ–∫ ---
        function processTextForBreaks(text) {
            if (!text) return "";
            // –ó–∞–º–µ–Ω—è–µ–º —Å–∏–º–≤–æ–ª –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ (\n) –Ω–∞ HTML —Ç–µ–≥ —Ä–∞–∑—Ä—ã–≤–∞ —Å—Ç—Ä–æ–∫–∏ (<br>)
            return text.replace(/\n/g, '<br>');
        }
        // ----------------------------------------------


        function renderDialogueStep() {
            const { dialogueWrapper, spriteLeftContainer, spriteRightContainer, 
                    spriteLeftElement, spriteRightElement, currentSpeaker, currentText, speakerNameContainer,
                    fullDialogueBox, fullDialogueContent, fullCurrentText } = elements;

            if (!dialogueIsLoaded || currentDialogue.length === 0) {
                dialogueWrapper.classList.add('hidden');
                fullDialogueBox.classList.add('hidden');
                return;
            }

            const step = currentDialogue[currentDialogueIndex];
            const isFullText = step.text_style === 'full';
            
            // 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–æ–Ω
            dialogueWrapper.classList.toggle('hidden', isFullText);
            fullDialogueBox.classList.toggle('hidden', !isFullText);
            
            // 2. –§–æ–Ω (–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–æ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –ø—Ä–µ–ª–æ–∞–¥–∞/–∑–∞–≥—Ä—É–∑–∫–∏)
            if (step.background) { 
                crossFadeBackground(step.background);
            }

            // --- 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –°–ø—Ä–∞–π—Ç–∞–º–∏ (–í–∏–¥–∏–º–æ—Å—Ç—å –∏ –ó–∞–≥—Ä—É–∑–∫–∞) ---
            
            const newLeftSpriteFile = step.sprite_left || null;
            const newRightSpriteFile = step.sprite_right || null;

            // A. –õ–µ–≤—ã–π –°–ø—Ä–∞–π—Ç
            if (newLeftSpriteFile) {
                const url = spritePath(newLeftSpriteFile);
                if (currentLeftSpriteFile !== newLeftSpriteFile) {
                    loadSprite(url, spriteLeftElement, spriteLeftContainer);
                    currentLeftSpriteFile = newLeftSpriteFile;
                } else {
                    spriteLeftContainer.classList.remove('hidden');
                }
            } else {
                spriteLeftContainer.classList.add('hidden');
                spriteLeftElement.src = ''; 
                currentLeftSpriteFile = null;
            }

            // B. –ü—Ä–∞–≤—ã–π –°–ø—Ä–∞–π—Ç
            if (newRightSpriteFile) {
                 const url = spritePath(newRightSpriteFile);
                if (currentRightSpriteFile !== newRightSpriteFile) {
                    loadSprite(url, spriteRightElement, spriteRightContainer);
                    currentRightSpriteFile = newRightSpriteFile;
                } else {
                    spriteRightContainer.classList.remove('hidden');
                }
            } else {
                spriteRightContainer.classList.add('hidden');
                spriteRightElement.src = ''; 
                currentRightSpriteFile = null;
            }
            
            // --- C. –õ–æ–≥–∏–∫–∞ –ó–∞—Ç–µ–º–Ω–µ–Ω–∏—è (–ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ä–µ–∂–∏–º—É) ---
            
            // 1. –°–±—Ä–æ—Å –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è
            spriteLeftElement.classList.remove('dimmed-sprite');
            spriteRightElement.classList.remove('dimmed-sprite');

            let dimTarget = 'none'; 

            if (step.dim_override && !isFullText) { 
                const overrideValue = step.dim_override.toLowerCase();

                if (overrideValue === 'auto' && step.speaker && step.position) {
                    const isLeftSpeaker = step.position.toLowerCase() === 'left';
                    dimTarget = isLeftSpeaker ? 'right' : 'left';
                } else if (overrideValue === 'left' || overrideValue === 'right' || overrideValue === 'both' || overrideValue === 'none') {
                    dimTarget = overrideValue;
                }
            }

            // --- 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è –∫ –≤–∏–¥–∏–º—ã–º —Å–ø—Ä–∞–π—Ç–∞–º ---
            if (!isFullText) {
                // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ª–µ–≤–æ–≥–æ —Å–ø—Ä–∞–π—Ç–∞
                const shouldDimLeft = dimTarget === 'left' || dimTarget === 'both';
                if (shouldDimLeft && !spriteLeftContainer.classList.contains('hidden')) {
                    spriteLeftElement.classList.add('dimmed-sprite');
                }

                // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤–æ–≥–æ —Å–ø—Ä–∞–π—Ç–∞
                const shouldDimRight = dimTarget === 'right' || dimTarget === 'both';
                if (shouldDimRight && !spriteRightContainer.classList.contains('hidden')) {
                    spriteRightElement.classList.add('dimmed-sprite');
                }
            }

            // --- 5. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¢–µ–∫—Å—Ç–∞ ---

            if (isFullText) {
                // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ë–æ–ª—å—à–æ–≥–æ –î–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –û–∫–Ω–∞ ---
                
                // 1. –¢–µ–∫—Å—Ç (–ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä–µ–Ω–æ—Å–æ–≤)
                fullCurrentText.innerHTML = processTextForBreaks(step.text);
                
                // 2. –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'md')
                const size = step.full_text_size || 'md';
                fullCurrentText.className = 'leading-relaxed transition-opacity duration-300'; // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤
                fullCurrentText.classList.add(`full-text-${size}`);
                
                // 3. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'top-left')
                const align = step.full_text_align || 'top-left';
                
                // –°–±—Ä–æ—Å –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
                fullDialogueContent.classList.remove('align-top-left', 'align-center');
                if (align === 'center') {
                    fullDialogueContent.classList.add('align-center');
                } else {
                    fullDialogueContent.classList.add('align-top-left');
                }
                
                currentSpeaker.textContent = ""; 
                speakerNameContainer.classList.add('hidden');

            } else {
                // --- –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –î–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –û–∫–Ω–∞ ---
                
                if (step.speaker) {
                    currentSpeaker.textContent = step.speaker;
                    speakerNameContainer.classList.remove('hidden');
                } else {
                    currentSpeaker.textContent = "";
                    speakerNameContainer.classList.add('hidden');
                }
                
                // –¢–µ–∫—Å—Ç (–ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä–µ–Ω–æ—Å–æ–≤)
                currentText.innerHTML = processTextForBreaks(step.text);
            }
            
            // 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ò—Å—Ç–æ—Ä–∏–∏
            if (isHistoryVisible) {
                renderHistory();
            }
        }
        
        /**
         * –£–õ–£–ß–®–ï–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤—ã.
         * –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –∞—Å—Å–µ—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥–ª–∞–≤—ã –ü–ï–†–ï–î –Ω–∞—á–∞–ª–æ–º,
         * –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –ø–ª–∞–≤–Ω—ã–π –æ–ø—ã—Ç –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫.
         */
        async function updateStoryContent() {
            const lang = currentLang;
            const fullStoryKey = elements.chapterSelect.value.trim();
            const { loadButton, loadText, chapterLoadOverlay, chapterLoadProgress } = elements;

            if (!fullStoryKey) return;

            // --- –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ ---
            loadButton.disabled = true;
            loadText.textContent = i18n[lang].loadingText;
            chapterLoadOverlay.classList.remove('hidden');
            chapterLoadProgress.textContent = `(0/?)`;

            // --- –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ JSON —Ñ–∞–π–ª–∞ –≥–ª–∞–≤—ã ---
            const expectedFilePath = `${CONFIG.PATHS.STORY_BASE}${lang}/${fullStoryKey}.json`;
            let chapterData;
            try {
                const response = await fetch(expectedFilePath);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                chapterData = await response.json();
                if (!chapterData || !Array.isArray(chapterData.dialogue)) {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç JSON: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–∞—Å—Å–∏–≤ 'dialogue'.");
                }
            } catch (error) {
                console.error(`[Content Load] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON –≥–ª–∞–≤—ã: ${expectedFilePath}`, error);
                alertMessage(i18n[lang].errorChapterNotFound);
                loadText.textContent = i18n[lang].loadText;
                loadButton.disabled = false;
                chapterLoadOverlay.classList.add('hidden');
                return;
            }

            // --- –®–∞–≥ 3: –°–±–æ—Ä –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö URL –∞—Å—Å–µ—Ç–æ–≤ –∏–∑ –≥–ª–∞–≤—ã ---
            const urlsToLoad = (() => {
                const uniqueUrls = new Set();
                for (const step of chapterData.dialogue) {
                    if (step.background) uniqueUrls.add(CONFIG.PATHS.BACKGROUND_BASE + encodeURIComponent(step.background));
                    if (step.sprite_left) uniqueUrls.add(spritePath(step.sprite_left));
                    if (step.sprite_right) uniqueUrls.add(spritePath(step.sprite_right));
                }
                return Array.from(uniqueUrls);
            })();

            // --- –®–∞–≥ 4: –ü–∞–∫–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∞—Å—Å–µ—Ç–æ–≤ –≥–ª–∞–≤—ã ---
            const BATCH_SIZE = 10;
            let loadedCount = 0;
            const totalToLoad = urlsToLoad.length;

            if (totalToLoad > 0) {
                 for (let i = 0; i < totalToLoad; i += BATCH_SIZE) {
                    const batch = urlsToLoad.slice(i, i + BATCH_SIZE);
                    const batchPromises = batch.map(url => loadImage(url).catch(err => console.warn(err)));
                    
                    await Promise.allSettled(batchPromises);

                    loadedCount += batch.length;
                    const progress = Math.min(loadedCount, totalToLoad);
                    chapterLoadProgress.textContent = `(${progress}/${totalToLoad})`;
                }
            } else {
                 chapterLoadProgress.textContent = `(0/0)`;
            }

            // --- –®–∞–≥ 5: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ ---
            currentDialogue = chapterData.dialogue;
            currentDialogueIndex = 0;
            dialogueIsLoaded = true;
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —á–∏—Å—Ç–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            currentBackgroundUrl = null;
            currentLeftSpriteFile = null;
            currentRightSpriteFile = null;
            elements.spriteLeftContainer.classList.add('hidden');
            elements.spriteRightContainer.classList.add('hidden');
            elements.spriteLeftElement.src = '';
            elements.spriteRightElement.src = '';
            elements.fullDialogueBox.classList.add('hidden'); 

            renderDialogueStep(); // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä

            // --- –®–∞–≥ 6: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ —Å–±—Ä–æ—Å UI ---
            chapterLoadOverlay.classList.add('hidden');
            loadText.textContent = i18n[lang].loadedText;
            setTimeout(() => {
                loadText.textContent = i18n[lang].loadText;
                loadButton.disabled = false;
            }, 1500);
        }

        // ====================================================================
        // === UI & I18N FUNCTIONS ===
        // ====================================================================

        function alertMessage(message) {
            const header = document.getElementById('header');
            const msgBox = document.createElement('div');
            msgBox.textContent = message;
            msgBox.className = 'fixed top-1 right-1/2 translate-x-1/2 p-2 text-white rounded-lg shadow-xl z-50 text-sm transition-opacity duration-300 alert-message';
            header.appendChild(msgBox);
            
            setTimeout(() => {
                msgBox.style.opacity = '0';
                setTimeout(() => msgBox.remove(), 300);
            }, 5000);
        }

        function updateI18nStrings() {
            const lang = currentLang; 
            const text = i18n[lang];
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('headerTitle').textContent = text.headerTitle;
            document.getElementById('labelStoryType').textContent = text.labelStoryType;
            document.getElementById('labelArc').textContent = text.labelArc; 
            document.getElementById('labelChapter').textContent = text.labelChapter;
            elements.loadText.textContent = text.loadText;
            elements.historyText.textContent = text.historyButton;
            elements.historyTitle.textContent = text.historyTitle;

            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            elements.themeText.textContent = currentTheme === 'dark' ? text.themeDark : text.themeLight;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –¢–∏–ø–∞ –°—é–∂–µ—Ç–∞
            const typeSelect = elements.storyTypeSelect;
            const currentType = typeSelect.value;
            typeSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = `--- ${text.placeholderSelectType} ---`;
            typeSelect.appendChild(defaultOption);

            for (const key in STORY_GROUPS) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = STORY_GROUPS[key][lang]; 
                if (key === currentType) { 
                    option.selected = true;
                }
                typeSelect.appendChild(option);
            }
        }
        
        /**
         * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞ —Å—é–∂–µ—Ç–∞.
         */
        function updateArcAndChapterUI() {
            updateI18nStrings(); 
            
            const typeKey = elements.storyTypeSelect.value;
            const arcSelect = elements.arcSelect;
            const arcContainer = elements.arcSelectContainer;
            const lang = currentLang; 
            
            const currentArcKey = arcSelect.value; 
            
            arcSelect.innerHTML = '';
            arcSelect.disabled = true;
            if (typeKey !== 'main') {
                 arcSelect.value = ""; 
            }

            if (typeKey === 'main') {
                arcContainer.classList.remove('hidden');
                
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `--- ${i18n[lang].labelArc} ---`; 
                arcSelect.appendChild(defaultOption);
                
                let arcFound = false;
                for (const key in MAIN_STORY_ARCS) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = MAIN_STORY_ARCS[key][lang];
                    if (key === currentArcKey) { 
                        option.selected = true;
                    }
                    arcSelect.appendChild(option);
                    arcFound = true;
                }
                arcSelect.disabled = !arcFound;

            } else {
                arcContainer.classList.add('hidden');
                arcSelect.value = ""; 
            }
            
            updateChapterSelect();
        }

        /**
         * –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ –ì–ª–∞–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¢–∏–ø–∞ –∏ –ê—Ä–∫–∏.
         */
        function updateChapterSelect() {
            const typeKey = elements.storyTypeSelect.value;
            const arcKey = elements.arcSelect.value;       
            const select = elements.chapterSelect;
            const lang = currentLang; 
            
            const currentChapterKey = select.value;

            select.innerHTML = '';
            select.disabled = true; 
            select.value = ""; 
            
            if (!window.storyMetadata) {
                select.innerHTML = `<option value="">${i18n[lang].placeholderMetadata}</option>`;
                enableLoadButton();
                return;
            }
            
            if (!typeKey) {
                 select.innerHTML = `<option value="">--- ${i18n[lang].placeholderSelectType} ---</option>`;
                 enableLoadButton();
                 return;
            }
            
            if (typeKey === 'main' && !arcKey) { 
                select.innerHTML = `<option value="">--- ${i18n[lang].placeholderSelectArc} ---</option>`;
                 enableLoadButton();
                 return;
            }
            
            const storyGroup = STORY_GROUPS[typeKey];
            if (!storyGroup) {
                 select.innerHTML = `<option value="">--- ${i18n[lang].placeholderSelectType} ---</option>`;
                 enableLoadButton();
                 return;
            }
            
            let targetPrefix = '';
            
            if (typeKey === 'main') {
                // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø 'main', –ø—Ä–µ—Ñ–∏–∫—Å –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –∞—Ä–∫—É –∏ 'main_'
                targetPrefix = `${arcKey}_main_`; 
            } else {
                // –ò–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –≥—Ä—É–ø–ø—ã
                targetPrefix = storyGroup.prefix; 
            }

            // =================================================
            // DEBUG LOGS –î–õ–Ø –û–¢–õ–ê–î–ö–ò –ü–†–û–ë–õ–ï–ú–´ –ì–õ–ê–í–´ 11
            // =================================================
            // console.log(`[DEBUG: Chapter Filter] –¶–µ–ª–µ–≤–æ–π –ø—Ä–µ—Ñ–∏–∫—Å: "${targetPrefix}"`); 

            select.innerHTML = `<option value="">--- ${i18n[lang].labelChapter} ---</option>`;

            let chapterFound = false;
            
            for (const fullChapterKey in window.storyMetadata) {
                // console.log(`[DEBUG: Chapter Filter] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–∞: "${fullChapterKey}"`); 
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –∫–ª—é—á –≥–ª–∞–≤—ã —Å —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞. 
                // –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –≥–ª–∞–≤, –≤–∫–ª—é—á–∞—è ch11
                if (fullChapterKey.startsWith(targetPrefix)) {
                    
                    const chapterData = window.storyMetadata[fullChapterKey];
                    const chapterName = chapterData[lang] || chapterData['ru']; // Fallback –Ω–∞ —Ä—É—Å—Å–∫–∏–π
                    
                    if (chapterName) {
                        const option = document.createElement('option');
                        option.value = fullChapterKey; 
                        option.textContent = chapterName; 
                        
                        if (fullChapterKey === currentChapterKey) {
                             option.selected = true;
                        }
                        select.appendChild(option);
                        chapterFound = true;
                    }
                }
            }
            
            if (chapterFound) {
                 select.disabled = false;
            } else {
                 select.innerHTML = `<option value="">--- –ì–ª–∞–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ---</option>`;
            }
            
            enableLoadButton();
        }
        
        function initializeOrUpdateUI(isLangChange = false) {
             if (isLangChange) {
                 // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é —è–∑—ã–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                 currentLang = elements.languageSelect.value;
                 localStorage.setItem(CONFIG.STORAGE.LANG_KEY, currentLang);
                 
                 // –ü—Ä–∏ —Å–º–µ–Ω–µ —è–∑—ã–∫–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
                 currentDialogue = [];
                 dialogueIsLoaded = false;
             }
             
             // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç lang –¥–ª—è HTML, —á—Ç–æ–±—ã CSS –º–æ–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
             document.documentElement.lang = currentLang;
             
             // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä
             elements.languageSelect.value = currentLang; 
             
             updateArcAndChapterUI(); 
             // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –∫–Ω–æ–ø–∫–µ —Ç–µ–º—ã
             const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
             applyTheme(currentTheme);
        }

        function enableLoadButton() {
            const storyId = elements.chapterSelect.value;
            elements.loadButton.disabled = !storyId; 
        }

        // ====================================================================
        // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ò–°–¢–û–†–ò–ï–ô ===
        // ====================================================================

        function toggleHistory() {
            isHistoryVisible = !isHistoryVisible;
            elements.historyPanel.classList.toggle('open', isHistoryVisible);
            
            if (isHistoryVisible) {
                setTimeout(renderHistory, 300); 
            }
        }

        function renderHistory() {
            const { historyContent } = elements;
            const lang = currentLang;
            historyContent.innerHTML = '';
            
            if (!dialogueIsLoaded || currentDialogue.length === 0) {
                historyContent.innerHTML = `<p class="text-center mt-8 p-3 rounded-lg" style="color: var(--color-text-secondary); background-color: var(--color-bg-medium);">${i18n[lang].historyEmpty}</p>`;
                return;
            }
            
            const fragment = document.createDocumentFragment();

            for (let i = 0; i <= currentDialogueIndex; i++) {
                const step = currentDialogue[i];
                if (!step.text && !step.background && i !== 0) continue; 
                
                const isCurrent = (i === currentDialogueIndex);

                const historyItem = document.createElement('div');
                
                historyItem.className = `p-3 rounded-lg cursor-pointer transition duration-150 shadow-md border border-transparent`;
                
                if (isCurrent) {
                    historyItem.classList.add('ring-2', 'ring-offset-2');
                    historyItem.style.backgroundColor = 'var(--color-accent-primary)'; 
                    historyItem.style.color = 'white';
                    historyItem.style.borderColor = 'var(--color-accent-ring)';
                    historyItem.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
                    historyItem.style.fontWeight = 'bold';
                } else {
                    historyItem.style.backgroundColor = 'var(--color-bg-medium)'; 
                    historyItem.style.color = 'var(--color-text-primary)';
                }
                
                historyItem.dataset.index = i; 
                historyItem.onclick = () => {
                    currentDialogueIndex = i;
                    renderDialogueStep();
                    toggleHistory(); 
                };

                // –í –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è —Å–ø–∏–∫–µ—Ä–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ Full Text, –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                let speakerNameText = step.speaker || '';
                
                if (step.text_style === 'full' && !speakerNameText) {
                    speakerNameText = i18n[lang].narrativePlaceholder;
                }
                
                if (speakerNameText) {
                    const speakerName = document.createElement('p');
                    speakerName.className = 'font-bold mb-1';
                    speakerName.style.color = isCurrent ? 'white' : 'var(--color-speaker-name)'; 
                    speakerName.textContent = speakerNameText;
                    historyItem.appendChild(speakerName);
                }

                const textContent = document.createElement('p');
                textContent.className = 'text-sm leading-snug';
                
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞, –Ω–æ –µ—Å—Ç—å —Ñ–æ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                let displayText = step.text;
                if (!displayText && step.background) {
                    displayText = `[${i18n[lang].scenePlaceholder}${step.background}]`;
                } else if (!displayText && i === 0) {
                    displayText = i18n[lang].startOfStory;
                }
                
                // –í –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º textContent
                textContent.textContent = displayText || ''; 
                historyItem.appendChild(textContent);

                fragment.appendChild(historyItem);
            }
            
            historyContent.appendChild(fragment);
            
            const currentItem = historyContent.querySelector(`[data-index="${currentDialogueIndex}"]`);
            if (currentItem) {
                currentItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    </script>
</body>
</html>

